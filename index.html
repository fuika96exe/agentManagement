<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Management App (Local Storage)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="css/app.css">
</head>
<body>
    <div class="container">
        
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            Loading Data...
        </div>

        <div class="main-content">
            <div id="dashboardView" class="view" style="display: none;">
                <div class="task-section">
                    <h2>Tasks</h2>
                    <div id="taskList" class="task-list">
                        </div>
                </div>
            </div>

            <div id="propertyView" class="view" style="display: none;">
                <div class="property-header">
                    <div class="search-container">
                        <span class="material-icons-round search-icon">search</span>
                        <input type="text" id="propertySearch" placeholder="Search properties, tenants, or owners...">
                        <button id="addButton" onclick="window.app.toggleAddMenu()" class="add-btn">
                            <span class="material-icons-round">add</span>
                        </button>

                        <div id="addMenu" class="add-menu">
                            <a href="#" onclick="window.app.handleNewEntry('property'); return false;">
                                <span class="material-icons-round" style="font-size: 18px;">home</span> New Property
                            </a>
                            <a href="#" onclick="window.app.handleNewEntry('owner'); return false;">
                                <span class="material-icons-round" style="font-size: 18px;">person</span> New Owner
                            </a>
                            <a href="#" onclick="window.app.handleNewEntry('tenant'); return false;">
                                <span class="material-icons-round" style="font-size: 18px;">group</span> New Tenant
                            </a>
                        </div>
                    </div>
                </div>

                <div class="tab-bar">
                    <a href="#" id="tabProperty" class="active-tab" onclick="window.app.switchPropertyTab('property'); return false;">Property</a>
                    <a href="#" id="tabOwner" onclick="window.app.switchPropertyTab('owner'); return false;">Owner</a>
                    <a href="#" id="tabTenant" onclick="window.app.switchPropertyTab('tenant'); return false;">Tenant</a>
                </div>
                
                <div id="tabContentProperty" class="tab-content property-list" style="display: flex;">
                    </div>
                <div id="tabContentOwner" class="tab-content property-list" style="display: none;">
                    </div>
                <div id="tabContentTenant" class="tab-content property-list" style="display: none;">
                    </div>
            </div>
            
            <div id="formView" class="view" style="display: none;">
                <div class="property-header">
                    <a href="#" id="formBackBtn" class="back-btn" onclick="window.app.goBackFromForm(); event.stopPropagation(); return false;">
                        <span class="material-icons-round">arrow_back_ios</span>
                        Back
                    </a>
                </div>

                <div class="form-view-content">
                    <h2 id="formTitle" style="margin-top: 5px;"></h2>

                    <form id="dataEntryForm">
                        <input type="hidden" id="currentFormType" name="type" value=""> <input type="hidden" id="currentFormPhase" name="phase" value="0">
                        <input type="hidden" id="currentId" name="id" value=""> <input type="hidden" id="selectedOwnerId" name="ownerId" value="">
                        <input type="hidden" id="selectedTenantId" name="tenantId" value="">

                        <div id="formFields">
                            </div>
                    </form>
                </div>
            </div>

            <div id="detailView" class="view" style="display: none;">
                <div class="property-header">
                    <a href="#" class="back-btn" onclick="window.app.switchView('property'); window.app.switchPropertyTab('property'); return false;" style="margin: 0; padding: 0;">
                        <span class="material-icons-round">arrow_back_ios</span>
                        Property List
                    </a>
                    <div class="header-content">
                        <h2 id="detailPropertyName" style="margin: 10px 0 0; font-size: 24px; font-weight: 700; flex-grow: 1;">Property Name</h2>
                        <button id="detailEditBtn" class="add-btn" onclick="/* Set by JS function */">
                            <span class="material-icons-round" style="font-size: 22px;">edit</span>
                        </button>
                    </div>
                </div>
                <div id="detailContent" class="form-view-content" style="padding-top: 5px;">
                    </div>
                <div class="detail-footer">
                    <button class="delete-main-btn" onclick="window.app.deletePropertyHandler(document.getElementById('currentId').value, document.getElementById('detailPropertyName').textContent); return false;">
                        Delete Property
                    </button>
                </div>
            </div>
            
            <div id="ownerDetailView" class="view" style="display: none;">
                <div class="property-header">
                    <a href="#" class="back-btn" onclick="window.app.switchView('property'); window.app.switchPropertyTab('owner'); return false;" style="margin: 0; padding: 0;">
                        <span class="material-icons-round">arrow_back_ios</span>
                        Owner List
                    </a>
                    <div class="header-content">
                        <h2 id="detailOwnerName" style="margin: 10px 0 0; font-size: 24px; font-weight: 700; flex-grow: 1;">Owner Name</h2>
                        <button id="ownerEditBtn" class="add-btn" onclick="">
                            <span class="material-icons-round" style="font-size: 22px;">edit</span>
                        </button>
                    </div>
                </div>
                <div id="ownerDetailContent" class="form-view-content" style="padding-top: 5px;">
                    </div>
                <div class="detail-footer">
                    <button class="delete-main-btn" onclick="window.app.deleteProfileHandler(document.getElementById('currentId').value, 'owner', document.getElementById('detailOwnerName').textContent); return false;">
                        Delete Owner Profile
                    </button>
                </div>
            </div>

            <div id="tenantDetailView" class="view" style="display: none;">
                <div class="property-header">
                    <a href="#" class="back-btn" onclick="window.app.switchView('property'); window.app.switchPropertyTab('tenant'); return false;" style="margin: 0; padding: 0;">
                        <span class="material-icons-round">arrow_back_ios</span>
                        Tenant List
                    </a>
                    <div class="header-content">
                        <h2 id="detailTenantName" style="margin: 10px 0 0; font-size: 24px; font-weight: 700; flex-grow: 1;">Tenant Name</h2>
                        <button id="tenantEditBtn" class="add-btn" onclick="">
                            <span class="material-icons-round" style="font-size: 22px;">edit</span>
                        </button>
                    </div>
                </div>
                <div id="tenantDetailContent" class="form-view-content" style="padding-top: 5px;">
                    </div>
                <div class="detail-footer">
                    <button class="delete-main-btn" onclick="window.app.deleteProfileHandler(document.getElementById('currentId').value, 'tenant', document.getElementById('detailTenantName').textContent); return false;">
                        Delete Tenant Profile
                    </button>
                </div>
            </div>

        </div>

        <div class="navbar">
            <a href="#" id="navDashboard" class="active" onclick="window.app.switchView('dashboard'); return false;">
                <span class="material-icons-round">home</span>
                Home
            </a>
            <a href="#" id="navProperty" onclick="window.app.switchView('property'); window.app.switchPropertyTab('property'); return false;">
                <span class="material-icons-round">apartment</span>
                Property
            </a>
            <a href="#" onclick="window.app.alertMessage('Navigating to Services page...', 'info'); return false;">
                <span class="material-icons-round">apps</span>
                Services
            </a>
            <a href="#" onclick="window.app.alertMessage('Navigating to More page...', 'info'); return false;">
                <span class="material-icons-round">more_horiz</span>
                More
            </a>
        </div>
    </div>
    
    <div id="appMessageBox" class="app-message-box"></div>
    
    <div id="confirmModal" style="display: none;" class="modal-overlay">
        <div class="modal-content">
            <h3 id="confirmModalTitle">Confirm Deletion</h3>
            <p id="confirmModalMessage"></p>
            <div class="modal-actions">
                <button id="confirmModalCancel" class="btn-cancel">Cancel</button>
                <button id="confirmModalConfirm" class="btn-confirm">Delete</button>
            </div>
        </div>
    </div>

    <script>
        
        let properties = [];
        let tasks = [];
        let owners = []; 
        let tenants = []; 
        let currentUserId = 'local_user_123'; 
        
        // MALAYSIAN STATES for select dropdown
        const MALAYSIAN_STATES = [
            "Johor", "Kedah", "Kelantan", "Melaka", "Negeri Sembilan", "Pahang", 
            "Penang", "Perak", "Perlis", "Sabah", "Sarawak", "Selangor", "Terengganu",
            "Kuala Lumpur", "Labuan", "Putrajaya"
        ];
        
        // HOUSE TYPES for select dropdown
        const HOUSE_TYPES = [
            "Apartment", "Condo", "Landed House", "Studio", "Duplex", "Townhouse", "Shop Lot"
        ];
        
        // RENTAL TYPES for select dropdown (Removed Chinese for consistency)
        const RENTAL_TYPES = [
            {val: 'whole_unit', label: 'Whole Unit Rental'},
            {val: 'room_by_room', label: 'Room-by-Room Rental'}
        ];
        
        // Rent Reminder Message (Point 3)
        const RENT_REMINDER_MESSAGE = "Kindly reminder: Your rent is due on the 1st of this month. Please make the payment promptly. Thank you!";
        
        // Rent Reminder Date (Point 3)
        const RENT_REMINDER_DAY = 4;


        // ===================================
        // Utility: Local Storage Management
        // ===================================
        
        function loadData() {
            const storedProperties = localStorage.getItem('properties');
            properties = storedProperties ? JSON.parse(storedProperties) : [];
            
            const storedTasks = localStorage.getItem('tasks');
            tasks = storedTasks ? JSON.parse(storedTasks) : [];
            
            const storedOwners = localStorage.getItem('owners');
            owners = storedOwners ? JSON.parse(storedOwners) : [];

            const storedTenants = localStorage.getItem('tenants');
            tenants = storedTenants ? JSON.parse(storedTenants) : [];
            
            console.log("Data loaded from localStorage.");
        }

        function saveData() {
            localStorage.setItem('properties', JSON.stringify(properties));
            localStorage.setItem('tasks', JSON.stringify(tasks));
            localStorage.setItem('owners', JSON.stringify(owners));
            localStorage.setItem('tenants', JSON.stringify(tenants));
            console.log("Data saved to localStorage.");
            
            // Re-render based on current active tab
            if (currentView === 'property') {
                renderProperties();
                renderOwners();
                renderTenants();
            } else if (currentView === 'dashboard') {
                renderTasks();
            }
        }
        
        // ===================================
        // Utility: Message Box & Confirmation
        // ===================================

        const messageBox = document.getElementById('appMessageBox');
        const loadingOverlay = document.getElementById('loadingOverlay');
        let messageTimer;

        function showLoading() { loadingOverlay.style.display = 'flex'; }
        function hideLoading() { loadingOverlay.style.display = 'none'; }

        function alertMessage(message, type = 'info') {
            clearTimeout(messageTimer);

            messageBox.textContent = message;
            messageBox.className = `app-message-box ${type}`;
            
            requestAnimationFrame(() => {
                messageBox.classList.add('visible');
            });

            messageTimer = setTimeout(() => {
                messageBox.classList.remove('visible');
            }, 3000);
        }
        
        // Confirmation Modal Logic 
        let confirmCallback = null;

        function showConfirmation(title, message, callback) {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalMessage').textContent = message;
            confirmCallback = callback;
            document.getElementById('confirmModal').style.display = 'flex';
        }

        function hideConfirmation() {
            document.getElementById('confirmModal').style.display = 'none';
            confirmCallback = null;
        }

        document.getElementById('confirmModalCancel').onclick = hideConfirmation;
        document.getElementById('confirmModalConfirm').onclick = () => {
            if (confirmCallback) {
                confirmCallback(true);
            }
            hideConfirmation();
        };

        // ===================================
        // View Control and Navigation
        // ===================================
        let currentView = 'dashboard';
        let currentPropertyTab = 'property'; // State for the current tab in propertyView
        
        function switchView(viewName) {
            currentView = viewName;
            
            document.querySelectorAll('.view').forEach(view => {
                view.style.display = 'none';
            });

            const targetView = document.getElementById(viewName + 'View');
            const detailViews = ['detail', 'ownerDetail', 'tenantDetail'];

            if (targetView) {
                targetView.style.display = 'flex'; 
                targetView.style.flexDirection = 'column';
            } else if (detailViews.includes(viewName)) {
                // Handle new detail views
                document.getElementById(viewName + 'View').style.display = 'flex';
                document.getElementById(viewName + 'View').style.flexDirection = 'column';
            }
            
            document.querySelector('.main-content').style.paddingBottom = '70px'; 

            document.querySelectorAll('.navbar a').forEach(link => link.classList.remove('active'));
            if (viewName === 'dashboard') {
                document.getElementById('navDashboard').classList.add('active');
                // Ensure tasks are rendered when navigating to dashboard
                try { renderTasks(); } catch (e) { console.warn('renderTasks error:', e); }
            } else if (['property', 'form', 'detail', 'ownerDetail', 'tenantDetail'].includes(viewName)) { 
                document.getElementById('navProperty').classList.add('active');
                toggleAddMenu(false); 
                // When switching to property-level views, refresh the lists
                if (viewName === 'property') {
                    try {
                        renderProperties();
                        renderOwners();
                        renderTenants();
                    } catch (e) { console.warn('render property tabs error:', e); }
                }
            } 
        }

        function switchPropertyTab(tabName) {
            currentPropertyTab = tabName;
            document.querySelectorAll('.tab-bar a').forEach(link => link.classList.remove('active-tab'));
            document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active-tab');

            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            document.getElementById(`tabContent${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).style.display = 'flex';

            // Ensure the correct data is rendered when switching tabs
            if (tabName === 'property') renderProperties();
            if (tabName === 'owner') renderOwners();
            if (tabName === 'tenant') renderTenants();
        }

        /**
         * Toggles the visibility of a detail card and rotates the icon (Point 2)
         */
        function toggleCollapse(elementId) {
            const content = document.getElementById(elementId);
            const icon = document.getElementById(elementId + 'Icon');

            if (!content || !icon) return;

            const isVisible = content.style.display !== 'none';

            if (isVisible) {
                content.style.display = 'none';
                icon.classList.remove('rotate');
            } else {
                content.style.display = 'flex';
                content.style.flexWrap = 'wrap'; 
                icon.classList.add('rotate');
            }
        }

        function goBackFromForm() {
            const currentFormType = document.getElementById('currentFormType').value;
            const currentPhase = document.getElementById('currentFormPhase').value;
            const currentId = document.getElementById('currentId').value;
            
            if (currentFormType === 'owner') {
                // If owner form was opened from property phase 0 flow, go back to that property owner selection
                const selectedOwnerIdField = document.getElementById('selectedOwnerId');
                if (selectedOwnerIdField.value && selectedOwnerIdField.value.startsWith('prop-')) {
                    renderForm(selectedOwnerIdField.value, 0, 'property');
                    return;
                }
                // Otherwise, return to Owner tab
                switchView('property');
                switchPropertyTab('owner');
                return;
            }
            
            if (currentFormType === 'tenant') {
                // Do not delete tenant on back. Only navigate back to Tenant tab
                switchView('property');
                switchPropertyTab('tenant');
                return;
            }
            
            if (currentFormType === 'property') {
                if (currentPhase === '3') {
                    viewPropertyDetails(currentId);
                    return;
                }
                if (currentPhase === '2') {
                    renderForm(currentId, 1, 'property');
                    return;
                }
                if (currentPhase === '1') {
                    renderForm(currentId, 0, 'property');
                    return;
                }
                if (currentPhase === '0') {
                    const prop = getPropertyById(currentId);
                    if (prop && !prop.ownerId) {
                        properties = properties.filter(p => p.id !== currentId);
                        tasks = tasks.filter(t => t.propId !== currentId);
                        saveData();
                        alertMessage('New Property creation cancelled.', 'info');
                    }
                    switchView('dashboard');
                    return;
                }
            }
            
            switchView('dashboard');
        }
        
        function toggleAddMenu(force) {
            const menu = document.getElementById('addMenu');
            const isVisible = menu.classList.contains('visible');
            
            let shouldBeVisible = (typeof force === 'boolean') ? force : !isVisible;
            
            if (shouldBeVisible) {
                menu.classList.add('visible');
            } else {
                menu.classList.remove('visible');
            }
        }

        // --- Added for Tenant/Owner Handling ---
        function handleNewEntry(type) {
            toggleAddMenu(false);
            let newId;
            if (type === 'property') {
                newId = `prop-${Date.now()}`;
                // Start with Phase 0 for Owner selection
                renderForm(newId, 0, 'property');
            } else if (type === 'owner') {
                newId = `owner-${Date.now()}`;
                renderForm(newId, 0, 'owner');
            } else if (type === 'tenant') {
                newId = `tenant-${Date.now()}`;
                // Tenant creation starts at phase 0
                renderForm(newId, 0, 'tenant');
            }
        }

        function continueFormTask(id, isEditMode, type) {
            // ⬇️ MODIFICATION START: Add Debug Log for Entry Point
            console.log(`DEBUG: Entering continueFormTask. ID: ${id}, isEditMode: ${isEditMode}, Type: ${type}`);
            // ⬆️ MODIFICATION END
            
            let currentPhase;
            if (type === 'property') {
               const prop = getPropertyById(id);
               currentPhase = prop ? (prop.phase || 0) : 0;
               
               // ⬇️ MODIFICATION START: Add Debug Log for Phase Check
               console.log(`DEBUG: Property Phase Check. Current Phase: ${currentPhase}`);
               // ⬆️ MODIFICATION END
               
               // If it's a full detail edit (phase 3), force to phase 3 form (Point 1)
               // 【关键修改】我们强制让 'isEditMode' 忽略 Phase 检查，直接进入 Phase 3 全面编辑表单
               if(isEditMode) { // <-- 简化判断条件，只要是编辑模式就进入 Phase 3
                   console.log("DEBUG: Forcing transition to Phase 3 Full Edit Form.");
                   renderForm(id, 3, 'property');
                   return;
               }
            } else if (type === 'tenant') {
                const tenant = getTenantById(id);
                currentPhase = tenant ? (tenant.phase || 0) : 0;
                // If editing a created/completed tenant, enable simple edit on phase 0 only
                if (isEditMode && tenant && (tenant.created === true || tenant.phase >= 3)) {
                    window.app.simpleTenantEdit = true;
                    renderForm(id, 0, 'tenant');
                    return;
                }
                // If the tenant is incomplete, continue multi-step flow
                if (currentPhase >= 3) currentPhase = 0;
                const task = getTaskByTenantId(id);
                if (task) currentPhase = task.phase;
            } else if (type === 'owner') {
                // Owners do not have phases, always edit (Point 4)
                renderForm(id, 0, 'owner');
                return;
            }
            renderForm(id, currentPhase, type);
        }

        // ===================================
        // Detail View Navigators
        // ===================================

        function viewPropertyDetails(propId) {
			const prop = getPropertyById(propId);
			if (!prop || prop.phase < 3) return;
			const owner = getOwnerById(prop.ownerId); 
			const tenant = getTenantById(prop.tenantId); 
			
			document.getElementById('currentId').value = propId;
			renderPropertyDetailsContent(prop, owner, tenant); 
			
			// ⬇️ MODIFICATION START: Use getElementById once and add a console log for debugging
			const editBtn = document.getElementById('detailEditBtn'); // Get the button element
			
			if (editBtn) {
				// Log to confirm the code execution
				console.log(`DEBUG: Binding Edit Button for Property ID: ${prop.id}`); 
				
				// Bind the handler explicitly
				editBtn.onclick = function(event) { 
					event.preventDefault(); // Prevent any default action just in case
					console.log("DEBUG: Edit Button Clicked. Executing continueFormTask.");
					window.app.continueFormTask(prop.id, true, 'property'); 
					return false; 
				};
			} else {
				console.error("ERROR: Detail Edit Button element not found!");
			}
			// ⬆️ MODIFICATION END
			
			switchView('detail');
		}

        function viewOwnerDetails(ownerId) {
            const owner = getOwnerById(ownerId);
            if (!owner) return;
            
            document.getElementById('currentId').value = ownerId;
            renderOwnerDetailView(owner);
            switchView('ownerDetail');
        }

        function viewTenantDetails(tenantId) {
            const tenant = getTenantById(tenantId);
            if (!tenant) return;
            
            document.getElementById('currentId').value = tenantId;
            renderTenantDetailView(tenant);
            switchView('tenantDetail');
        }

        function deletePropertyHandler(propId, propName) {
            const displayName = propName && propName.trim() !== '' ? propName : 'this property';
            showConfirmation(
                'Confirm Deletion',
                `Are you sure you want to permanently delete the information for: ${displayName}? This action cannot be undone.`,
                (confirmed) => {
                    if (confirmed) {
                        deleteProperty(propId, displayName);
                        switchView('property');
                        switchPropertyTab('property');
                    }
                }
            );
        }

        function deleteProfileHandler(id, type, name) {
             const displayName = name && name.trim() !== '' ? name : `this ${type} profile`;
             const associatedProperties = properties.filter(p => p[`${type}Id`] === id);

             if (associatedProperties.length > 0) {
                 const propNames = associatedProperties.map(p => p.name).join(', ');
                 alertMessage(`Cannot delete ${type} profile. It is still linked to property/properties: ${propNames}.`, 'error');
                 return;
             }

             showConfirmation(
                'Confirm Deletion',
                `Are you sure you want to permanently delete the profile for: ${displayName}? This action cannot be undone.`,
                (confirmed) => {
                    if (confirmed) {
                        if (type === 'owner') {
                            owners = owners.filter(o => o.id !== id);
                            saveData();
                            switchView('property');
                            switchPropertyTab('owner');
                            alertMessage(`${displayName} deleted successfully.`, 'success');
                        } else if (type === 'tenant') {
                             tenants = tenants.filter(t => t.id !== id);
                             tasks = tasks.filter(t => t.tenantId !== id); // Remove associated tasks
                             saveData();
                             switchView('property');
                             switchPropertyTab('tenant');
                             alertMessage(`${displayName} deleted successfully.`, 'success');
                        }
                    }
                }
            );
        }
        
        function viewDummyFile(fileName) {
            alertMessage(`Simulating file view for: ${fileName}`, 'info');
        }
        
        // Rent Reminder Logic (Point 3)
        function sendRentReminder(taskId, propId) {
             const prop = getPropertyById(propId);
             const tenant = getTenantById(prop.tenantId);
             const propName = prop.name;
             const tenantName = tenant ? tenant.fullName : 'Tenant';
            
             // Copy message to clipboard
             const message = RENT_REMINDER_MESSAGE.replace('Tenant Name', tenantName).replace('Property Name', propName);
             navigator.clipboard.writeText(message).then(() => {
                 alertMessage(`Reminder message for ${propName} copied to clipboard! Task updated.`, 'success');

                 // 1. Mark current task as completed
                 const taskIndex = tasks.findIndex(t => t.id === taskId);
					 if (taskIndex !== -1) {
						 tasks[taskIndex].status = 'completed'; // <-- 必须确保这行代码正确执行
						 tasks[taskIndex].completedDate = new Date().toISOString().split('T')[0];
                     
                     // 2. Generate a new recurring task for the next month
                     const now = new Date();
                     const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, RENT_REMINDER_DAY); // Next 4th day
                     const nextMonthString = nextMonth.toISOString().split('T')[0];
                     
                     const nextTaskId = `rent-${propId}-${nextMonth.getFullYear()}-${nextMonth.getMonth() + 1}`;
                     
                     updateTaskData(nextTaskId, { 
                         id: nextTaskId, 
                         type: 'rent_reminder', 
                         propId: propId, 
                         isRent: true,
                         sendDate: nextMonthString, 
                         description: `Collect Rent for ${propName}`, 
                         details: `Due on 1st, Send reminder on ${nextMonthString}.`, 
                         status: 'in_progress', 
                         userId: currentUserId 
                     });

                     saveData();
                 }
                 renderTasks();

             }).catch(err => {
                 console.error('Could not copy text: ', err);
                 alertMessage('Failed to copy message to clipboard.', 'error');
             });
        }
        
        // Generates the first rent reminder task for a newly assigned tenant (Point 3)
        function createFirstRentTask(propId, propName) {
            const now = new Date();
            const nextMonth = new Date(now.getFullYear(), now.getMonth(), RENT_REMINDER_DAY);
            
            // If today is past the 4th, set the task for the next month
            if (now.getDate() > RENT_REMINDER_DAY) {
                 nextMonth.setMonth(now.getMonth() + 1);
            }
            // Ensure day is 4th
            nextMonth.setDate(RENT_REMINDER_DAY);

            const nextMonthString = nextMonth.toISOString().split('T')[0];
            const nextTaskId = `rent-${propId}-${nextMonth.getFullYear()}-${nextMonth.getMonth() + 1}`;
            
            // Check if task already exists to prevent duplication on edit save
            if (tasks.some(t => t.id === nextTaskId)) return;
            
            updateTaskData(nextTaskId, { 
                id: nextTaskId, 
                type: 'rent_reminder', 
                propId: propId, 
                isRent: true,
                sendDate: nextMonthString, 
                description: `Collect Rent for ${propName}`, 
                details: `Due on 1st, Send reminder on ${nextMonthString}.`, 
                status: 'in_progress', 
                userId: currentUserId 
            });
        }


        // ===================================
        // Local Data Logic (getters/updaters)
        // ===================================
        function getTaskByPropId(propId) { return tasks.find(t => t.propId === propId && t.type === 'property'); }
        function getTaskByTenantId(tenantId) { return tasks.find(t => t.tenantId === tenantId && t.type === 'tenant_setup'); }
        function getPropertyById(propId) { return properties.find(p => p.id === propId); }
        function getOwnerById(ownerId) { return owners.find(o => o.id === ownerId); }
        function getTenantById(tenantId) { return tenants.find(t => t.id === tenantId); }
        
        function updatePropertyData(propId, data) {
            let propIndex = properties.findIndex(p => p.id === propId);
            if (propIndex === -1) { properties.push({ id: propId, ...data }); } 
            else { properties[propIndex] = { ...properties[propIndex], ...data }; }
            saveData();
            return true;
        }

        function updateTaskData(taskId, data) {
            let taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) { tasks.push({ id: taskId, ...data }); } 
            else { tasks[taskIndex] = { ...tasks[taskIndex], ...data }; }
            saveData();
            return true;
        }

        function saveOwnerData(ownerId, data) {
            let ownerIndex = owners.findIndex(o => o.id === ownerId);
            if (ownerIndex === -1) { owners.push({ id: ownerId, ...data }); } 
            else { owners[ownerIndex] = { ...owners[ownerIndex], ...data }; }
            saveData();
            return true;
        }

        function saveTenantData(tenantId, data) {
            let tenantIndex = tenants.findIndex(t => t.id === tenantId);
            if (tenantIndex === -1) { tenants.push({ id: tenantId, ...data }); } 
            else { tenants[tenantIndex] = { ...tenants[tenantIndex], ...data }; }
            saveData();
            return true;
        }

        function deleteProperty(propId, propName) {
            showLoading();
            try {
                properties = properties.filter(p => p.id !== propId);
                tasks = tasks.filter(t => t.propId !== propId);
                saveData(); 
                alertMessage(`Property "${propName}" deleted successfully.`, 'success');
            } catch (error) {
                console.error("Error deleting property:", error);
                alertMessage('Failed to delete property and associated task.', 'error');
            } finally {
                hideLoading(); 
            }
        }


        // ===================================
        // Rendering Functions (Tabs)
        // ===================================
        
        function renderTasks() {
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';
            const now = new Date();
            const todayDate = now.toISOString().split('T')[0];
            const isSendDay = now.getDate() === RENT_REMINDER_DAY; // Point 3: Only clickable on the 4th

            // Filter out recurring tasks that are set for future months but not current/past
            const pendingTasks = tasks.filter(t => 
				t.status === 'in_progress' && (t.type !== 'rent_reminder' || t.sendDate <= todayDate)
			).sort((a, b) => {
                 // Sort priority tasks first (rent/property setup)
                 if (a.isRent && !b.isRent) return -1;
                 if (!a.isRent && b.isRent) return 1;
                 return 0;
            });
            
            if (pendingTasks.length === 0) {
                taskList.innerHTML = `
                    <div class="task-item">
                        <span class="material-icons-round icon" style="color: #6c757d;">check_circle_outline</span>
                        <div class="task-info">
                            <h3>No Tasks</h3>
                            <p>All outstanding tasks are complete!</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            pendingTasks.forEach(task => {
                let taskDescription = task.description;
                let taskDetails = task.details;
                let buttonAction;
                let buttonText = 'Edit';
                let buttonClass = 'action-btn';
                let iconName = 'edit_note';

                if (task.type === 'property') {
                    buttonAction = `window.app.continueFormTask('${task.propId}', false, 'property')`;
                } else if (task.type === 'tenant_setup') {
                    buttonAction = `window.app.continueFormTask('${task.tenantId}', false, 'tenant')`;
                    const tenant = getTenantById(task.tenantId);
                    taskDescription = `Setup Tenancy for ${tenant ? tenant.fullName : 'New Tenant'}`;
                } else if (task.type === 'rent_reminder' && task.isRent) {
                    // Rent Reminder Task Logic (Point 3)
                    buttonText = 'Send';
                    buttonClass += ` send-rent ${!isSendDay ? 'disabled' : ''}`;
                    buttonAction = `window.app.sendRentReminder('${task.id}', '${task.propId}')`;
                    iconName = 'payments';
                    taskDetails += isSendDay ? '' : ' (Active only on the 4th)';
                }

                taskList.innerHTML += `
                    <div class="task-item incomplete" onclick="if(!event.target.closest('a') && !event.target.classList.contains('disabled')) { ${buttonAction}; }">
                        <span class="material-icons-round icon">${iconName}</span>
                        <div class="task-info">
                            <h3>${taskDescription}</h3>
                            <p>${taskDetails}</p>
                        </div>
                        <a href="#" class="${buttonClass}" 
                           onclick="${buttonAction}; return false;"
                           ${!isSendDay && task.type === 'rent_reminder' ? 'disabled' : ''}>
                           ${buttonText}
                        </a>
                    </div>
                `;
            });
        }
        
        // Caches property list when running filter
        let currentProperties = [];

        function filterProperties() {
            const searchTerm = (document.getElementById('propertySearch')?.value || '').toLowerCase().trim();
            if (!searchTerm) {
                currentProperties = properties;
                renderPropertiesList(currentProperties);
                return;
            }

            // Fixed filter logic (Point 5)
            currentProperties = properties.filter(p => {
                const owner = getOwnerById(p.ownerId);
                const tenant = getTenantById(p.tenantId);

                return (
                    (p.name && p.name.toLowerCase().includes(searchTerm)) ||
                    (owner && owner.fullName && owner.fullName.toLowerCase().includes(searchTerm)) ||
                    (tenant && tenant.fullName && tenant.fullName.toLowerCase().includes(searchTerm))
                );
            });

            renderPropertiesList(currentProperties);
        }

        function renderPropertiesList(list) {
            const listContainer = document.getElementById('tabContentProperty');
            listContainer.innerHTML = '';
            
            if (list.length === 0) {
                 listContainer.innerHTML = `<div class="property-card" style="text-align: center; border-left: 5px solid #ccc; color: #666;">No property data found. Click the "+" button to add one.</div>`;
                 return;
            }

            // Sort logic - Rented comes before Vacant, both after Incomplete
            list.sort((a, b) => {
                const aComplete = a.phase && a.phase > 2;
                const bComplete = b.phase && b.phase > 2;
                
                if (aComplete !== bComplete) return aComplete ? 1 : -1;
                
                if (aComplete && bComplete) {
                    if (a.status === 'Rented' && b.status !== 'Rented') return -1;
                    if (a.status !== 'Rented' && b.status === 'Rented') return 1;
                }
                return 0; 
            });
            
            list.forEach(p => {
                const isComplete = p.phase && p.phase > 2;
                
                let statusClass;
                let statusText;
                let cardClass = 'property-card';
                let action;

                if (!isComplete) {
                    statusClass = 'status-incomplete';
                    statusText = 'Incomplete Details';
                    cardClass += ' incomplete-details';
                    action = `onclick="window.app.continueFormTask('${p.id}', false, 'property');"`;
                } else {
                    statusClass = p.status === 'Rented' ? 'status-rented' : 'status-vacant';
                    statusText = p.status || 'Vacant';
                    action = `onclick="window.app.viewPropertyDetails('${p.id}');"`;
                }

                const propName = p.name && p.name.trim() !== '' ? p.name : 'Property Name N/A';
                const propAddress = p.address || 'Address N/A';
                const propRent = p.monthlyRent ? `RM${p.monthlyRent.toLocaleString()}` : null;
                const tenant = p.tenantId ? getTenantById(p.tenantId) : null;
                const rooms = (p.rooms || p.rooms === 0) ? p.rooms : null;
                const baths = (p.bathrooms || p.bathrooms === 0) ? p.bathrooms : null;
                
                listContainer.innerHTML += `
                    <div class="${cardClass}" ${action}>
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <h4>${propName}</h4>
                            <span class="status-tag-prop ${statusClass}">${statusText}</span>
                        </div>
                        <div class="property-details-section">
                            <div class="detail-line address">
                                <p class="detail-item"><strong>Address:</strong> ${propAddress}</p>
                            </div>
                            ${isComplete ? (
                                p.status === 'Rented' && tenant ? `
                                    <div class="detail-line" style="justify-content: space-between; gap: 10px;">
                                        <p class="detail-item" style="width: 100%;"><strong>Tenant:</strong> ${tenant.fullName || 'Tenant'}</p>
                                    </div>
                                ` : `
                                    <div class="detail-line rent-specs" style="justify-content: space-between; gap: 10px;">
                                        ${propRent ? `<p class=\"detail-item\" style=\"width: 33%;\"><strong>Rent:</strong> ${propRent}</p>` : ''}
                                        ${rooms !== null ? `<p class=\"detail-item\" style=\"width: 33%;\"><strong>Rooms:</strong> ${rooms}</p>` : ''}
                                        ${baths !== null ? `<p class=\"detail-item\" style=\"width: 33%;\"><strong>Bathrooms:</strong> ${baths}</p>` : ''}
                                    </div>
                                `
                            ) : `<p style="color: #e65100;">Missing Rental/Spec Details. Click to continue.</p>`}
                        </div>
                        </div>
                `;
            });
        }
        
        function renderProperties() {
            // Check if there is a search term and use the filter logic
            filterProperties(); 
        }

        function renderOwners() {
            const listContainer = document.getElementById('tabContentOwner');
            listContainer.innerHTML = '';

            if (owners.length === 0) {
                 listContainer.innerHTML = `<div class="property-card" style="text-align: center; border-left: 5px solid #ccc; color: #666;">No owner profiles found. Click the "+" button to add one.</div>`;
                 return;
            }

            owners.forEach(o => {
                const associatedCount = properties.filter(p => p.ownerId === o.id).length;
                const statusText = associatedCount > 0 ? `${associatedCount} Properties` : 'No Properties';
                
                listContainer.innerHTML += `
                    <div class="property-card" onclick="window.app.viewOwnerDetails('${o.id}');">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <h4>${o.fullName || 'Owner Name N/A'}</h4>
                            <span class="status-tag-prop status-vacant" style="background-color: #eef4ff; color: #3A86FF;">${statusText}</span>
                        </div>
                        <div class="property-details-section">
                            <div class="detail-line address">
                                <p class="detail-item"><strong>Contact:</strong> ${o.phone || o.email || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function renderTenants() {
             const listContainer = document.getElementById('tabContentTenant');
            listContainer.innerHTML = '';
            
            if (tenants.length === 0) {
                 listContainer.innerHTML = `<div class="property-card" style="text-align: center; border-left: 5px solid #ccc; color: #666;">No tenant profiles found. Click the "+" button to add one.</div>`;
                 return;
            }

            tenants.forEach(t => {
                const associatedProperty = properties.find(p => p.tenantId === t.id);
                const isComplete = t.phase && t.phase >= 3; // Phase 3 means complete setup (uploaded agreement)

                let statusText;
                let statusClass;
                let action;
                let phaseDisplay = t.phase < 3 ? `${t.phase}/3 complete` : 'Setup Complete';


                if (associatedProperty) {
                    statusText = `Renting: ${associatedProperty.name}`;
                    statusClass = 'status-rented';
                    action = `onclick="window.app.viewTenantDetails('${t.id}');"`;
                } else if (!isComplete) {
                    statusText = `Setup: ${phaseDisplay}`;
                    statusClass = 'status-incomplete';
                    action = `onclick="window.app.continueFormTask('${t.id}', false, 'tenant');"`; 
                } else {
                    statusText = 'Unassigned (Setup Complete)';
                    statusClass = 'status-vacant';
                    action = `onclick="window.app.viewTenantDetails('${t.id}');"`;
                }
                
                listContainer.innerHTML += `
                    <div class="property-card ${statusClass === 'status-incomplete' ? 'incomplete-details' : ''}" ${action}>
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <h4>${t.fullName || 'Tenant Name N/A'}</h4>
                            <span class="status-tag-prop ${statusClass}">${statusText}</span>
                        </div>
                        <div class="property-details-section">
                            <div class="detail-line address">
                                <p class="detail-item"><strong>Contact:</strong> ${t.phone || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // ===================================
        // Detail View Rendering Functions
        // ===================================
        
        /**
         * Renders the Property Detail Content with collapsible cards (Point 2)
         */
        function renderPropertyDetailsContent(prop, owner, tenant) {
            document.getElementById('detailPropertyName').textContent = prop.name || 'Property Profile';
            
            const content = document.getElementById('detailContent');
            content.innerHTML = `
                <div class="detail-card rental-info">
                    <h3 style="margin: 0 0 15px; font-size: 16px; font-weight: 700; color: #3A86FF;">RENTAL INFORMATION</h3>
                    <div class="detail-group">
                        <div class="detail-item-aligned">
                            <p class="detail-label">Status</p>
                            <span class="status-tag-prop ${prop.status === 'Rented' ? 'status-rented' : 'status-vacant'} detail-value" style="margin-top: 2px;">
                                ${prop.status || 'Vacant'}
                            </span>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Rental Type</p>
                            <p class="detail-value">
                                ${RENTAL_TYPES.find(r => r.val === prop.rentalType)?.label || prop.rentalType || '-'}
                            </p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Monthly Rent (RM)</p>
                            <p class="detail-value">${prop.monthlyRent ? prop.monthlyRent.toLocaleString() : '-'}</p>
                        </div>
                    </div>
                </div>

                <div class="detail-card">
                    <h3 style="margin: 0 0 15px; font-size: 16px; font-weight: 700; color: #333;">BASIC INFORMATION</h3>
                    <div class="detail-group">
                         <div class="detail-item-full">
                            <p class="detail-label">Property Name</p>
                            <p class="detail-value">${prop.name || '-'}</p>
                        </div>
                        <div class="detail-item-full">
                            <p class="detail-label">Address</p>
                            <p class="detail-value">${prop.address || '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">City, State</p>
                            <p class="detail-value">${prop.city || '-'}, ${prop.state || '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Postal Code</p>
                            <p class="detail-value">${prop.postalCode || '-'}</p>
                        </div>
                        <div class="detail-item-full">
                            <p class="detail-label">Remark</p>
                            <p class="detail-value">${prop.remark || '-'}</p>
                        </div>
                    </div>
                </div>

                <div class="detail-card">
                    <h3 style="margin: 0 0 15px; font-size: 16px; font-weight: 700; color: #333;">SPECIFICATIONS</h3>
                    <div class="detail-group">
                        <div class="detail-item-aligned">
                            <p class="detail-label">House Type</p>
                            <p class="detail-value">${prop.houseType || '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Size (Sqft)</p>
                            <p class="detail-value">${prop.sizeSqft ? prop.sizeSqft.toLocaleString() : '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Rooms</p>
                            <p class="detail-value">${prop.rooms || '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Bathrooms</p>
                            <p class="detail-value">${prop.bathrooms || '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Carpark</p>
                            <p class="detail-value">${prop.carpark || '-'}</p>
                        </div>
                    </div>
                </div>

                <div class="detail-card owner-info collapse-card">
                    <div class="collapse-header" onclick="window.app.toggleCollapse('ownerDetailContentBody')">
                        <h3 style="font-size: 16px; font-weight: 700; color: #9B59B6;">
                            OWNER DETAILS ${owner ? `(${owner.fullName || 'N/A'})` : '(Not Assigned)'}
                        </h3>
                        <span class="material-icons-round collapse-icon" id="ownerDetailContentBodyIcon">expand_more</span>
                    </div>
                    <div id="ownerDetailContentBody" class="detail-group" style="display: none;">
                        ${owner ? `
                             <div class="detail-item-full" style="margin-bottom: 5px;">
                                <a href="#" onclick="window.app.viewOwnerDetails('${owner.id}'); return false;" style="font-size: 13px; color: #3A86FF; font-weight: 600;">
                                    <span class="material-icons-round" style="font-size: 18px; vertical-align: middle;">person</span> View Owner Profile
                                </a>
                            </div>
                            <div class="detail-item-aligned">
                                <p class="detail-label">Full Name</p>
                                <p class="detail-value">${owner.fullName || '-'}</p>
                            </div>
                            <div class="detail-item-aligned">
                                <p class="detail-label">Phone Number</p>
                                <p class="detail-value">${owner.phone || '-'}</p>
                            </div>
                            <div class="detail-item-full"> 
                                <p class="detail-label">Email Address</p>
                                <p class="detail-value">${owner.email || '-'}</p>
                            </div>
                            <div class="detail-item-aligned">
                                <p class="detail-label">Management Fee</p>
                                <p class="detail-value">${owner.managementFee ? owner.managementFee + '%' : '-'}</p>
                            </div>
                        ` : '<p class="detail-value" style="color: #999;">No owner is currently assigned.</p>'}
                    </div>
                </div>

                <div class="detail-card tenant-info collapse-card">
                     <div class="collapse-header" onclick="window.app.toggleCollapse('tenantDetailContentBody')">
                        <h3 style="font-size: 16px; font-weight: 700; color: #155724;">
                            TENANT DETAILS ${tenant ? `(${tenant.fullName || 'N/A'})` : '(Vacant)'}
                        </h3>
                        <span class="material-icons-round collapse-icon" id="tenantDetailContentBodyIcon">expand_more</span>
                    </div>
                    <div id="tenantDetailContentBody" class="detail-group" style="display: none;">
                        ${tenant ? `
                             <div class="detail-item-full" style="margin-bottom: 5px;">
                                <a href="#" onclick="window.app.viewTenantDetails('${tenant.id}'); return false;" style="font-size: 13px; color: #3A86FF; font-weight: 600;">
                                    <span class="material-icons-round" style="font-size: 18px; vertical-align: middle;">person</span> View Tenant Profile
                                </a>
                            </div>
                            <div class="detail-item-aligned">
                                <p class="detail-label">Full Name</p>
                                <p class="detail-value">${tenant.fullName || '-'}</p>
                            </div>
                            <div class="detail-item-aligned">
                                <p class="detail-label">Phone Number</p>
                                <p class="detail-value">${tenant.phone || '-'}</p>
                            </div>
                            <div class="detail-item-aligned">
                                <p class="detail-label">Lease Start</p>
                                <p class="detail-value">${tenant.leaseStart || '-'}</p>
                            </div>
                            <div class="detail-item-aligned">
                                <p class="detail-label">Lease End</p>
                                <p class="detail-value">${tenant.leaseEnd || '-'}</p>
                            </div>
                        ` : '<p class="detail-value" style="color: #999;">No tenant is currently assigned to this property.</p>'}
                    </div>
                </div>
            `;
        }

        function renderOwnerDetailView(owner) {
            document.getElementById('detailOwnerName').textContent = owner.fullName || 'Owner Profile';
            document.getElementById('ownerEditBtn').setAttribute('onclick', `window.app.continueFormTask('${owner.id}', true, 'owner'); return false;`); // Changed to continueFormTask (Point 4)
            
            const associatedProperties = properties.filter(p => p.ownerId === owner.id);
            const propList = associatedProperties.map(p => 
                `<div class="detail-item-full" style="margin-bottom: 6px;">
                    <p class="detail-value" style="font-size: 15px; margin: 0;">
                        <a href="#" onclick="window.app.viewPropertyDetails('${p.id}'); return false;">
                            ${p.name} (${p.status})
                        </a>
                    </p>
                 </div>`
            ).join('');

            const content = document.getElementById('ownerDetailContent');
            content.innerHTML = `
                <div class="detail-card owner-info">
                    <h3 style="margin: 0 0 15px; font-size: 16px; font-weight: 700; color: #9B59B6;">OWNER DETAILS</h3>
                    <div id="ownerDetails" class="detail-group">
                        <div class="detail-item-aligned">
                            <p class="detail-label">Full Name</p>
                            <p class="detail-value">${owner.fullName || '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Phone Number</p>
                            <p class="detail-value">${owner.phone || '-'}</p>
                        </div>
                        <div class="detail-item-full"> 
                            <p class="detail-label">Email Address</p>
                            <p class="detail-value">${owner.email || '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Management Fee</p>
                            <p class="detail-value">${owner.managementFee ? owner.managementFee + '%' : '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Bank Account Details</p>
                            <p class="detail-value">${owner.bankDetails || '-'}</p>
                        </div>
                        <div class="detail-item-full">
                            <p class="detail-label">Mailing Address</p>
                            <p class="detail-value">${owner.address || '-'}</p>
                        </div>
                    </div>
                </div>

                <div class="detail-card">
                    <h3 style="margin: 0 0 15px; font-size: 16px; font-weight: 700; color: #333;">ASSOCIATED PROPERTIES (${associatedProperties.length})</h3>
                    <div class="detail-group">
                        ${associatedProperties.length > 0 ? propList : '<p class="detail-value" style="color: #999;">No properties currently linked.</p>'}
                    </div>
                </div>
            `;
        }
        
        function renderTenantDetailView(tenant) {
            document.getElementById('detailTenantName').textContent = tenant.fullName || 'Tenant Profile';
            const action = tenant.phase >= 3 ? `window.app.continueFormTask('${tenant.id}', true, 'tenant'); return false;` : `window.app.continueFormTask('${tenant.id}', false, 'tenant'); return false;`; // Changed to continueFormTask (Point 4)
            document.getElementById('tenantEditBtn').setAttribute('onclick', action);
            
            const associatedProperty = properties.find(p => p.tenantId === tenant.id);
            
            const content = document.getElementById('tenantDetailContent');
            content.innerHTML = `
                <div class="detail-card tenant-info">
                    <h3 style="margin: 0 0 15px; font-size: 16px; font-weight: 700; color: #155724;">TENANT DETAILS</h3>
                    <div class="detail-group">
                        <div class="detail-item-aligned">
                            <p class="detail-label">Full Name</p>
                            <p class="detail-value">${tenant.fullName || '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Phone Number</p>
                            <p class="detail-value">${tenant.phone || '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Email Address</p>
                            <p class="detail-value">${tenant.email || '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">IC/Passport</p>
                            <p class="detail-value">${tenant.icPassport || '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Lease Start</p>
                            <p class="detail-value">${tenant.leaseStart || '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Lease End</p>
                            <p class="detail-value">${tenant.leaseEnd || '-'}</p>
                        </div>
                        <div class="detail-item-full">
                            <p class="detail-label">Tenancy Agreement</p>
                            <p class="detail-value">
                                ${tenant.agreementFile ? `
                                    <a href="#" onclick="window.app.viewDummyFile('${tenant.agreementFile}'); return false;" class="file-link">
                                        <span class="material-icons-round">description</span> View Signed Agreement
                                    </a>
                                ` : 'N/A (Agreement Missing)'}
                            </p>
                        </div>
                    </div>
                </div>

                <div class="detail-card">
                    <h3 style="margin: 0 0 15px; font-size: 16px; font-weight: 700; color: #333;">ASSOCIATED PROPERTY</h3>
                    <div class="detail-group">
                        ${associatedProperty ? `
                            <p class="detail-value" style="font-size: 15px;">
                                <a href="#" onclick="window.app.viewPropertyDetails('${associatedProperty.id}'); return false;">
                                    ${associatedProperty.name} (${associatedProperty.address})
                                </a>
                            </p>
                        ` : '<p class="detail-value" style="color: #999;">Not currently linked to a property.</p>'}
                    </div>
                </div>
            `;
        }

        // ===================================
        // Form Logic
        // ===================================

        function renderPropertyFields(prop, isEditMode) {
            const existingData = prop || {};
            const houseTypeOptions = HOUSE_TYPES.map(type => 
                `<option value="${type}" ${existingData.houseType === type ? 'selected' : ''}>${type}</option>`
            ).join('');
            
            const rentalTypeOptions = RENTAL_TYPES.map(opt => `<option value="${opt.val}" ${existingData.rentalType === opt.val ? 'selected' : ''}>${opt.label}</option>`).join('');

            const stateOptions = MALAYSIAN_STATES.map(state => 
                `<option value="${state}" ${existingData.state === state ? 'selected' : ''}>${state}</option>`
            ).join('');

            // Basic Info (Part of Point 2 from previous request)
            let basicHtml = `
                <div class="detail-card">
                    <h3 style="margin: 0 0 15px; font-size: 16px; font-weight: 700; color: #333;">BASIC INFORMATION</h3>
                    <div class="detail-group">
                        <div class="detail-item-full form-group">
                            <label for="p-name">Property Name <span style="color:red">*</span></label>
                            <input type="text" id="p-name" name="name" value="${existingData.name || ''}" required>
                        </div>
                        <div class="detail-item-full form-group">
                            <label for="p-address">Address <span style="color:red">*</span></label>
                            <input type="text" id="p-address" name="address" value="${existingData.address || ''}" required>
                        </div>
                        <div class="detail-item-aligned form-group">
                            <label for="p-postal">Postal Code <span style="color:red">*</span></label>
                            <input type="text" id="p-postal" name="postalCode" value="${existingData.postalCode || ''}" required>
                        </div>
                        <div class="detail-item-aligned form-group">
                            <label for="p-city">City <span style="color:red">*</span></label>
                            <input type="text" id="p-city" name="city" value="${existingData.city || ''}" required>
                        </div>
                        <div class="detail-item-aligned form-group">
                            <label for="p-state">State <span style="color:red">*</span></label>
                            <select id="p-state" name="state" required onchange="window.app.checkSelectPlaceholder(this.id)">
                                <option value="" disabled ${!existingData.state ? 'selected' : ''}>Select State</option>
                                ${stateOptions}
                            </select>
                        </div>
                        <div class="detail-item-aligned form-group">
                            <label for="p-country">Country <span style="color:red">*</span></label>
                            <input type="text" id="p-country" name="country" value="${existingData.country || 'Malaysia'}" required>
                        </div>
                        <div class="detail-item-full form-group">
                            <label for="p-remark">Remark</label>
                            <input type="text" id="p-remark" name="remark" value="${existingData.remark || ''}">
                        </div>
                    </div>
                </div>
            `;
            
            // Rental Info
            let rentalHtml = `
                <div class="detail-card rental-info">
                     <h3 style="margin: 0 0 15px; font-size: 16px; font-weight: 700; color: #3A86FF;">RENTAL INFORMATION</h3>
                    <div class="detail-group">
                        <div class="detail-item-full form-group" style="margin-bottom: 10px;">
                            <label for="p-rentalType">Rental Type <span style="color:red">*</span></label>
                            <select id="p-rentalType" name="rentalType" required 
                                onchange="window.app.updateRentLabel(this.value); window.app.checkSelectPlaceholder(this.id);">
                                <option value="" disabled ${!existingData.rentalType ? 'selected' : ''}>Select Rental Type</option>
                                ${rentalTypeOptions}
                            </select>
                        </div>
                        
                        <div class="rental-detail-item form-group">
                            <label for="p-type">House Type <span style="color:red">*</span></label>
                            <select id="p-type" name="houseType" required onchange="window.app.checkSelectPlaceholder(this.id)">
                                <option value="" disabled ${!existingData.houseType ? 'selected' : ''}>Select Type</option>
                                ${houseTypeOptions}
                            </select>
                        </div>
                        <div class="rental-detail-item form-group">
                            <label id="rentLabel" for="p-rent" class="detail-label">Monthly Rental (RM) <span style="color:red">*</span></label>
                            <input type="number" id="p-rent" name="monthlyRent" value="${existingData.monthlyRent || ''}" required>
                        </div>
                        
                         ${isEditMode ? `
                            <div class="detail-item-full form-group" style="margin-top: 15px;">
                                <label for="p-status">Rental Status <span style="color:red">*</span></label>
                                <select id="p-status" name="status" required onchange="window.app.checkSelectPlaceholder(this.id)">
                                    <option value="" disabled ${!existingData.status ? 'selected' : ''}>Select Status</option>
                                    <option value="Vacant" ${existingData.status === 'Vacant' ? 'selected' : ''}>Vacant</option>
                                    <option value="Rented" ${existingData.status === 'Rented' ? 'selected' : ''}>Rented</option>
                                </select>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            // Specification (reordered: Rooms/Bathrooms first row, then Size/Carpark)
            let specHtml = `
                <div class="detail-card">
                     <h3 style="margin: 0 0 15px; font-size: 16px; font-weight: 700; color: #333;">SPECIFICATIONS</h3>
                    <div class="detail-group">
                        <div class="detail-item-aligned form-group">
                            <label for="p-rooms">No. of Rooms <span style="color:red">*</span></label>
                            <input type="number" id="p-rooms" name="rooms" value="${existingData.rooms || ''}" required>
                        </div>
                        <div class="detail-item-aligned form-group">
                            <label for="p-bathrooms">No. of Bathrooms <span style="color:red">*</span></label>
                            <input type="number" id="p-bathrooms" name="bathrooms" value="${existingData.bathrooms || ''}" required>
                        </div>
                        <div class="detail-item-aligned form-group">
                            <label for="p-size">Size (Sqft)</label>
                            <input type="number" id="p-size" name="sizeSqft" value="${existingData.sizeSqft || ''}">
                        </div>
                        <div class="detail-item-aligned form-group">
                            <label for="p-carpark">Carpark</label>
                            <input type="number" id="p-carpark" name="carpark" value="${existingData.carpark || ''}">
                        </div>
                    </div>
                </div>
            `;
            
            // Order required: Rental, Basic, Specification (Point 2)
            return rentalHtml + basicHtml + specHtml;
        }


        /**
         * Dynamic update Monthly Rent label based on rentalType selection.
         */
        function updateRentLabel(rentalType) {
            const labelElement = document.getElementById('rentLabel');
            if (!labelElement) return;

            if (rentalType === 'whole_unit') {
                labelElement.innerHTML = 'Monthly Rental (Whole Unit) <span style="color:red">*</span>';
            } else if (rentalType === 'room_by_room') {
                labelElement.innerHTML = 'Monthly Rental (Estimated Total) <span style="color:red">*</span>';
            } else {
                labelElement.innerHTML = 'Monthly Rental (RM) <span style="color:red">*</span>';
            }
        }

        /**
         * Helper to visually adjust select color based on value.
         */
        function checkSelectPlaceholder(id) {
            const select = document.getElementById(id);
            if (select) {
                // Use a proper class/check to ensure selected options are dark
                if (select.value === "" || select.value === null || select.selectedIndex === 0) {
                    select.style.color = '#999'; 
                } else {
                    select.style.color = '#333'; 
                }
            }
        }
        
        function selectTenant(tenantId) {
             const select = document.getElementById('p-tenantId');
             if (select) {
                 select.value = tenantId;
             }
             // checkSelectPlaceholder will handle the color change automatically
        }


        function handleFormSubmit(e) {
             e.preventDefault();
            
            const currentId = document.getElementById('currentId').value;
            const currentPhase = document.getElementById('currentFormPhase').value;
            const currentFormType = document.getElementById('currentFormType').value;
            const formEl = document.getElementById('dataEntryForm');
            const isSimpleTenantEdit = formEl && formEl.dataset && formEl.dataset.simpleEdit === 'true';
            const formData = new FormData(formEl);
            
            const updateData = {};
            for (let [key, value] of formData.entries()) {
                if (key === 'phase' || key === 'type' || key === 'id' || key === 'ownerId' || key === 'tenantId') continue; 
                
                if (['monthlyRent', 'sizeSqft', 'rooms', 'bathrooms', 'carpark', 'managementFee'].includes(key)) {
                    updateData[key] = parseFloat(value) || 0; 
                } else {
                    updateData[key] = value;
                }
            }
            
            if (currentFormType === 'owner') {
                createOwnerHandler(formData); // This handles save/update logic
                return;
            }

            // Tenant Multi-Step Logic
            if (currentFormType === 'tenant') {
                 const tenant = getTenantById(currentId);
                 const task = getTaskByTenantId(currentId);
                 // Simple edit path: update basic info only and return to tenant list
                 if (isSimpleTenantEdit) {
                    saveTenantData(currentId, { ...(tenant || {}), ...updateData, created: true, phase: tenant && tenant.phase ? tenant.phase : 3 });
                    saveData();
                    window.app.simpleTenantEdit = false;
                    alertMessage('Tenant updated.', 'success');
                    // 返回到 Tenant Profile 页面
                    viewTenantDetails(currentId);
                    return;
                 }
                 const nextPhase = parseInt(currentPhase) + 1;
                 
                 if (currentPhase === '0') {
                    saveTenantData(currentId, {...updateData, phase: nextPhase});
                    updateTaskData(`task-${currentId}`, { id: `task-${currentId}`, type: 'tenant_setup', tenantId: currentId, phase: nextPhase, description: `Setup Tenancy for ${updateData.fullName || 'New Tenant'}`, details: 'Step 2/3: Send and await signed tenancy agreement.', status: 'in_progress', userId: currentUserId });
                    renderForm(currentId, nextPhase, 'tenant');
                } else if (currentPhase === '1') {
                    // ⬇️ 关键修改 START：确保现有 tenant 数据被保留
                    saveTenantData(currentId, { ...tenant, phase: nextPhase }); 
                    // 若任务不存在，则创建；存在则更新
                    const taskId = task && task.id ? task.id : `task-${currentId}`;
                    updateTaskData(taskId, {
                        id: taskId,
                        type: 'tenant_setup',
                        tenantId: currentId,
                        phase: nextPhase,
                        details: 'Step 3/3: Upload the signed tenancy agreement.',
                        status: 'in_progress',
                        userId: currentUserId
                    });
                    renderForm(currentId, nextPhase, 'tenant');
                } else if (currentPhase === '2') {
                    const agreementFile = document.getElementById('t-agreementFile').files[0];
                    if (!agreementFile) { alertMessage('Please upload the signed Tenancy Agreement.', 'error'); return; }
                    const fileName = agreementFile.name;
                    // ⬇️ 关键修改 START：确保现有 tenant 数据被保留
                    saveTenantData(currentId, { ...tenant, ...updateData, agreementFile: fileName, created: true, phase: nextPhase });
                    // ⬆️ 关键修改 END
                    tasks = tasks.filter(t => t.id !== task.id);
                    saveData();
                    alertMessage(`Tenant ${tenant.fullName || 'Tenant'} setup successfully!`, 'success');
                    switchView('property'); 
                    switchPropertyTab('tenant');
                }
                return;
            }

            // Property Logic 
            const prop = getPropertyById(currentId);
            const task = getTaskByPropId(currentId);
            
            if (currentPhase === '0') {
                const selectedOwnerId = document.getElementById('selectedOwnerId').value;
                if (!selectedOwnerId) { alertMessage('Please select or create an Owner Profile first.', 'error'); return; }
                updatePropertyData(currentId, {...updateData, phase: 1, ownerId: selectedOwnerId});
                // 仅在用户点击 Next（提交）时创建/更新任务
                const taskId = task?.id || `task-${currentId}`;
                updateTaskData(taskId, { id: taskId, type: 'property', propId: currentId, phase: 1, description: `Fill in details for New Property`, details: 'Step 2/2: Fill basic details.', status: 'in_progress', userId: currentUserId });
                renderForm(currentId, 1, 'property'); 
            } 
            else if (currentPhase === '1') {
                // Requirement: finalize property here, default status Vacant
                showLoading();
                const propName = (updateData.name && updateData.name.trim() !== '') ? updateData.name : (prop && prop.name) ? prop.name : 'New Property';
                updatePropertyData(currentId, { ...(prop || {}), ...updateData, phase: 3, status: 'Vacant' });
                if (task) { tasks = tasks.filter(t => t.id !== task.id); }
                saveData();
                alertMessage(`Property "${propName}" saved successfully!`, 'success');
                document.getElementById('dataEntryForm').reset();
                switchView('dashboard');
                hideLoading();
            }
            else if (currentPhase === '3') {
                // Phase 3 Edit Mode (Point 3)
                showLoading();
                const oldTenantId = prop.tenantId;
                const newTenantId = document.getElementById('p-tenantId')?.value || '';
                
                // Update Property data
                updatePropertyData(currentId, {...updateData, phase: 3, status: updateData.status || 'Vacant', tenantId: newTenantId});
                
                // If a new tenant is assigned, create the recurring rent task
                if (newTenantId && newTenantId !== oldTenantId) {
                     alertMessage('Tenant successfully assigned. Creating monthly rent reminder task.', 'info');
                     createFirstRentTask(currentId, updateData.name || prop.name);
                }
                
                saveData(); 
                alertMessage(`Property "${updateData.name || prop.name}" updated successfully.`, 'success');
                viewPropertyDetails(currentId);
                hideLoading(); 
            }
        }

        function renderForm(id, phase, type) { 
            const formTitle = document.getElementById('formTitle');
            const formFields = document.getElementById('formFields');
            const form = document.getElementById('dataEntryForm');
            
            document.getElementById('currentFormType').value = type;
            document.getElementById('currentFormPhase').value = phase;
            document.getElementById('currentId').value = id;
            document.getElementById('selectedOwnerId').value = id.startsWith('prop-') ? document.getElementById('selectedOwnerId').value : ''; 

            if (type === 'owner') { 
                // Owner Form Logic (Point 4)
                const ownerToEdit = getOwnerById(id);
                document.getElementById('formTitle').textContent = ownerToEdit ? 'Edit Owner Profile' : 'Create New Owner Profile';
                document.getElementById('formBackBtn').innerHTML = `<span class="material-icons-round">arrow_back_ios</span> Cancel`;
                
                let existingData = ownerToEdit || {};
                 let fieldsHTML = `
                    <div class="detail-card">
                        <div class="detail-group">
                            <div class="detail-item-full form-group">
                                <label for="p-fullName">Full Name <span style="color:red">*</span></label>
                                <input type="text" id="p-fullName" name="fullName" value="${existingData.fullName || ''}" required>
                            </div>
                            <div class="detail-item-aligned form-group">
                                <label for="p-phone">Phone Number <span style="color:red">*</span></label>
                                <input type="tel" id="p-phone" name="phone" value="${existingData.phone || ''}" required>
                            </div>
                            <div class="detail-item-aligned form-group">
                                <label for="p-email">Email Address <span style="color:red">*</span></label>
                                <input type="email" id="p-email" name="email" value="${existingData.email || ''}" required>
                            </div>
                            <div class="detail-item-full form-group">
                                <label for="p-address">Mailing Address</label>
                                <input type="text" id="p-address" name="address" value="${existingData.address || ''}">
                            </div>
                            <div class="detail-item-full form-group">
                                <label for="p-bankDetails">Bank Account Details <span style="color:red">*</span></label>
                                <input type="text" id="p-bankDetails" name="bankDetails" value="${existingData.bankDetails || ''}" required>
                            </div>
                            <div class="detail-item-full form-group">
                                <label for="p-managementFee">Management Fee (%)</label>
                                <input type="number" id="p-managementFee" name="managementFee" value="${existingData.managementFee || ''}" placeholder="e.g., 8">
                            </div>
                        </div>
                    </div>
                `;
                fieldsHTML += `
                    <div class="form-footer">
                        <button type="submit" class="submit-btn" id="formSubmitButton" form="dataEntryForm">
                            ${ownerToEdit ? 'Save Changes' : 'Create Owner'}
                        </button>
                    </div>
                `;
                document.getElementById('formFields').innerHTML = fieldsHTML;
                switchView('form');
                return;
            }
             if (type === 'tenant') { 
                // Tenant Form Logic (Point 4)
                 const tenant = getTenantById(id);
                 let existingData = tenant || {};
                 let formTitleText = '';
                 let submitButtonText = '';
                 let fieldsHTML = '';
                 const simpleEdit = window.app.simpleTenantEdit === true && existingData.created === true;
                 form.dataset.simpleEdit = simpleEdit;
                
                if (phase === 0) {
                    formTitleText = simpleEdit ? 'Edit Tenant' : '1/3: Basic Tenant Information';
                    submitButtonText = simpleEdit ? 'Save Changes' : 'Save & Next';
                    fieldsHTML = `
                        <div class="detail-card">
                            <p style="color: #666; margin-top: 0;">Fill in the tenant's key details.</p>
                            <div class="detail-group">
                                <div class="detail-item-full form-group">
                                    <label for="t-fullName">Full Name <span style="color:red">*</span></label>
                                    <input type="text" id="t-fullName" name="fullName" value="${existingData.fullName || ''}" required>
                                </div>
                                <div class="detail-item-aligned form-group">
                                    <label for="t-phone">Phone Number <span style="color:red">*</span></label>
                                    <input type="tel" id="t-phone" name="phone" value="${existingData.phone || ''}" required>
                                </div>
                                <div class="detail-item-aligned form-group">
                                    <label for="t-email">Email Address</label>
                                    <input type="email" id="t-email" name="email" value="${existingData.email || ''}">
                                </div>
                                <div class="detail-item-full form-group">
                                    <label for="t-icPassport">IC/Passport Number <span style="color:red">*</span></label>
                                    <input type="text" id="t-icPassport" name="icPassport" value="${existingData.icPassport || ''}" required>
                                </div>
                                <div class="detail-item-aligned form-group">
                                    <label for="t-leaseStart">Lease Start Date</label>
                                    <input type="date" id="t-leaseStart" name="leaseStart" value="${existingData.leaseStart || ''}">
                                </div>
                                <div class="detail-item-aligned form-group">
                                    <label for="t-leaseEnd">Lease End Date</label>
                                    <input type="date" id="t-leaseEnd" name="leaseEnd" value="${existingData.leaseEnd || ''}">
                                </div>
                            </div>
                        </div>
                    `;
                 } else if (phase === 1) {
                    formTitleText = '2/3: Send Tenancy Agreement';
                    submitButtonText = 'Next';
                    fieldsHTML = `
                        <div class="detail-card">
                            <p style="color:#666; margin: 0 0 10px; font-size: 14px;">Please confirm the recipient before sending the tenancy agreement.</p>
                            <div class="detail-item-full" style="margin-bottom: 8px;">
                                <p class="detail-label" style="margin-bottom: 2px;">Tenant</p>
                                <p class="detail-value" style="font-size: 16px; color:#3A86FF;">${existingData.fullName || 'N/A'}</p>
                            </div>
                            <div class="detail-item-full" style="margin-bottom: 8px;">
                                <p class="detail-label" style="margin-bottom: 2px;">Contact</p>
                                <p class="detail-value" style="font-size: 16px;">${existingData.phone || 'N/A'}</p>
                            </div>
                            <a href="#" class="submit-btn" style="background-color: #25d366; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; max-width: 100%; box-sizing: border-box;" onclick="window.app.alertMessage('Simulating WhatsApp message sent!', 'success'); return false;">
                                <span class="material-icons-round" style="vertical-align: middle;">chat</span>
                                Send via WhatsApp
                            </a>
                            <a href="#" class="submit-btn" style="background-color: #f7931e; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; max-width: 100%; box-sizing: border-box;" onclick="window.app.alertMessage('Simulating Email sent!', 'success'); return false;">
                                <span class="material-icons-round" style="vertical-align: middle;">mail</span>
                                Send via Email
                            </a>
                        </div>
                    `;
                } else if (phase === 2) {
                    formTitleText = '3/3: Upload Signed Agreement';
                    submitButtonText = 'Complete Tenant Setup';

                    fieldsHTML = `
                        <div class="detail-card">
                            <p style="color: #666; margin-top: 0;">Upload the signed Tenancy Agreement received from the tenant.</p>
                            
                            <div class="detail-item-full form-group">
                                <label for="t-agreementFile">Tenancy Agreement File <span style="color:red">*</span></label>
                                <input type="file" id="t-agreementFile" name="agreementFile" required>
                            </div>
                            
                            ${existingData.agreementFile ? `
                                <p style="font-size: 14px; color: #555; margin-top: 15px;">
                                    Current File: 
                                    <a href="#" onclick="window.app.viewDummyFile('${existingData.agreementFile}'); return false;" class="file-link">
                                        <span class="material-icons-round">insert_drive_file</span> ${existingData.agreementFile}
                                    </a>
                                </p>
                            ` : ''}
                        </div>
                    `;
                 }
                document.getElementById('formTitle').textContent = formTitleText;
				document.getElementById('formFields').innerHTML = fieldsHTML + `
					<div class="form-footer">
						<button type="submit" class="submit-btn" id="formSubmitButton" form="dataEntryForm">
							${submitButtonText}
						</button>
					</div>
				`;
				switchView('form'); // <-- 确保这一行存在且能执行
				return;
            }

            const prop = getPropertyById(id);
            const existingData = prop || {};
            let currentOwnerId = existingData.ownerId;
            let submitButtonText = '';
            let fieldsHTML = '';

            // Adjust back button text based on mode
            document.getElementById('formBackBtn').innerHTML = `<span class="material-icons-round">arrow_back_ios</span> ${phase === 3 ? 'Details' : 'Back'}`;
            
            form.onsubmit = window.app.handleFormSubmit;

            // --- PHASE 0: OWNER SELECTION/CREATION ---
            if (phase === 0) {
                formTitle.textContent = '0/2: Select Property Owner';
                if (!currentOwnerId) document.getElementById('selectedOwnerId').value = ''; 

                fieldsHTML = `
                    <div class="detail-card">
                        <p style="margin-top: 0; color: #555;">Select an existing owner or create a new one for this property.</p>
                        
                        <input type="text" id="ownerSearch" placeholder="Search owner by name or phone..." oninput="window.app.filterOwners(this.value)">

                        <div id="ownerListContainer" style="min-height: 100px;">
                            <p style="text-align: center; color: #999; padding: 10px;">Start typing above to search for owners.</p>
                        </div>
                    </div>

                    <div class="detail-card" style="margin-top: 10px;">
                        <a href="#" onclick="window.app.handleNewEntry('owner'); document.getElementById('selectedOwnerId').value = '${id}'; return false;" style="display: block; text-align: center; color: #3A86FF; font-weight: 600; text-decoration: none; padding: 5px;">
                            <span class="material-icons-round" style="font-size: 18px; vertical-align: middle;">add</span> Create New Owner Profile
                        </a>
                    </div>
                `;
                submitButtonText = 'Next';
            }
            // --- PHASE 1: BASIC PROPERTY DETAILS ---
            else if (phase === 1) {
                formTitle.textContent = '1/2: Basic Property Details'; 
                // Requirement: Finalize on this step
                submitButtonText = 'Save Property';
                
                fieldsHTML = renderPropertyFields(prop, false);
                
                window.app.checkSelectPlaceholder('p-state');
                window.app.checkSelectPlaceholder('p-rentalType');
                window.app.checkSelectPlaceholder('p-type');
            } 
            // --- PHASE 2 is no longer used for creation flow ---
            else if (phase === 2) {
                formTitle.textContent = 'Specifications & Rental (legacy)';
                submitButtonText = 'Save Property';
                fieldsHTML = renderPropertyFields(prop, true);
                window.app.checkSelectPlaceholder('p-rentalType');
                window.app.checkSelectPlaceholder('p-type');
                window.app.checkSelectPlaceholder('p-status');
                if (existingData.rentalType) { updateRentLabel(existingData.rentalType); }
            }
            // --- PHASE 3: FULL EDIT MODE (Point 1) ---
            else if (phase === 3) {
                formTitle.textContent = `Editing: ${prop.name || 'Property'}`;
                submitButtonText = 'Save Changes';
                document.getElementById('formBackBtn').innerHTML = `<span class="material-icons-round">arrow_back_ios</span> Details`;
                
                // Get tenants not associated with any *other* property
                const assignedTenantIds = properties.filter(p => p.id !== id && p.tenantId).map(p => p.tenantId);
                const vacantTenants = tenants.filter(t => t.phase >= 3 && !assignedTenantIds.includes(t.id)); 
                const currentTenant = existingData.tenantId ? getTenantById(existingData.tenantId) : null;
                
                let tenantOptions = '';
                if(currentTenant) {
                    tenantOptions += `<option value="${currentTenant.id}" selected>${currentTenant.fullName || 'Tenant N/A'} (Current)</option>`;
                }
                tenantOptions += vacantTenants.map(t => 
                    `<option value="${t.id}" ${existingData.tenantId === t.id && !currentTenant ? 'selected' : ''}>${t.fullName || 'Tenant N/A'} (${t.phone || 'Contact N/A'})</option>`
                ).join('');

                // Render Basic, Rental, Specification
                fieldsHTML = renderPropertyFields(prop, true);
                
                // Manually inject the corrected Tenant Assignment Card
                fieldsHTML += `
                    <div class="detail-card tenant-info">
                        <h3 style="margin: 0 0 15px; font-size: 16px; font-weight: 700; color: #155724;">
                            TENANT ASSIGNMENT
                        </h3>
                        <div class="detail-group">
                            <div class="detail-item-full form-group">
                                <label for="p-tenantId" class="detail-label">Current Tenant</label>
                                <select id="p-tenantId" name="tenantId" onchange="window.app.selectTenant(this.value); window.app.checkSelectPlaceholder(this.id);" class="placeholder-text">
                                    <option value="" ${!existingData.tenantId ? 'selected' : ''}>-- Select Current Tenant (Vacant) --</option>
                                    ${tenantOptions}
                                </select>
                            </div>
                            <div class="detail-item-full form-group" style="margin-top: 10px;">

                            </div>
                            <div class="detail-item-full form-group" style="margin-top: 10px;">
                                <p style="font-size: 12px; color: #555;">Note: Only 'Setup Complete' tenants who are not currently assigned to another property are shown above.</p>
                            </div>
                        </div>
                    </div>
                `;
                
                // Manually apply select color checks after fields are added
                window.app.checkSelectPlaceholder('p-state');
                window.app.checkSelectPlaceholder('p-rentalType');
                window.app.checkSelectPlaceholder('p-type');
                window.app.checkSelectPlaceholder('p-status');
                window.app.checkSelectPlaceholder('p-tenantId');

                if (existingData.rentalType) {
                    updateRentLabel(existingData.rentalType);
                }
            } else {
                formFields.innerHTML = '<p style="color: red;">Form phase error. Please restart the process.</p>';
                return; 
            }
            
            // Inject submit button after fields for all phases
            const isTenantPhase1 = (type === 'tenant' && String(phase) === '1');
            const buttonTypeAttr = isTenantPhase1 ? 'button' : 'submit';
            fieldsHTML += `
				<div class="form-footer">
					<button type="${buttonTypeAttr}" class="submit-btn" id="formSubmitButton" form="dataEntryForm" 
						${phase === 0 && !currentOwnerId && !document.getElementById('selectedOwnerId').value ? 'disabled' : ''}>
						${submitButtonText}
					</button>
				</div>
			`;
            
            formFields.innerHTML = fieldsHTML;
            
            switchView('form'); 
            // ensure we clear any simple edit flag for non-tenant forms
            if (type !== 'tenant') {
                document.getElementById('dataEntryForm').dataset.simpleEdit = 'false';
            }
            // For tenant forms, persist simple edit flag to dataset for submit handling
            if (type === 'tenant') {
                document.getElementById('dataEntryForm').dataset.simpleEdit = (window.app.simpleTenantEdit === true) ? 'true' : 'false';
            }

            // Bind submit handler to prevent reload and run SPA logic
            if (form) {
                form.onsubmit = window.app.handleFormSubmit;
                // Prevent Enter key from submitting unexpectedly
                form.addEventListener('keydown', function(ev) {
                    if (ev.key === 'Enter') {
                        ev.preventDefault();
                    }
                });
                // Disable native validation popup to keep SPA flow
                form.setAttribute('novalidate', 'novalidate');
            }

            // Extra safety: explicitly bind click on the Next/Save button to prevent default navigation
            const submitBtn = document.getElementById('formSubmitButton');
            if (submitBtn) {
                submitBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    // Fast-path: ensure tenant phase 1 advances even if submit event is intercepted elsewhere
                    const currentType = document.getElementById('currentFormType').value;
                    const currentPhaseVal = document.getElementById('currentFormPhase').value;
                    const currentIdVal = document.getElementById('currentId').value;
                    if (currentType === 'tenant' && String(currentPhaseVal) === '1') {
                        const tenant = getTenantById(currentIdVal) || {};
                        const nextPhase = 2;
                        saveTenantData(currentIdVal, { ...tenant, phase: nextPhase });
                        const existingTask = getTaskByTenantId(currentIdVal);
                        const taskId = existingTask && existingTask.id ? existingTask.id : `task-${currentIdVal}`;
                        updateTaskData(taskId, {
                            id: taskId,
                            type: 'tenant_setup',
                            tenantId: currentIdVal,
                            phase: nextPhase,
                            details: 'Step 3/3: Upload the signed tenancy agreement.',
                            status: 'in_progress',
                            userId: currentUserId
                        });
                        renderForm(currentIdVal, nextPhase, 'tenant');
                        return false;
                    }
                    window.app.handleFormSubmit(e);
                    return false;
                });
            }

            // Delegate: prevent default navigation for any placeholder links inside form view
            const formViewContent = document.querySelector('.form-view-content');
            if (formViewContent) {
                formViewContent.addEventListener('click', function(ev) {
                    const target = ev.target.closest('a');
                    if (target && target.getAttribute('href') === '#') {
                        ev.preventDefault();
                    }
                });
            }

            // CRITICAL: Handle Phase 0 owner selection styling/state
            if (phase === 0) {
                if (currentOwnerId) {
                    window.app.selectOwner(currentOwnerId);
                }
                const selectedOwnerIdField = document.getElementById('selectedOwnerId');
                if (selectedOwnerIdField.value.startsWith('owner-')) {
                    window.app.selectOwner(selectedOwnerIdField.value);
                }
            }
        }
        
        function createOwnerHandler(formData) {
			const ownerId = document.getElementById('currentId').value;
			const data = {};
			for (let [key, value] of formData.entries()) {
				if (!['phase', 'type', 'id', 'ownerId', 'tenantId'].includes(key)) {
					data[key] = value;
				}
			}

			saveOwnerData(ownerId, data);
			alertMessage(`Owner ${data.fullName || ''} saved successfully.`, 'success');

			// Check if we came from the Property Phase 0 flow
			const selectedOwnerIdField = document.getElementById('selectedOwnerId');
			if (selectedOwnerIdField.value && selectedOwnerIdField.value.startsWith('prop-')) {
				const propId = selectedOwnerIdField.value;
				selectedOwnerIdField.value = ownerId; // Set the newly created owner as selected
				renderForm(propId, 0, 'property');
				window.app.selectOwner(ownerId);
			} else {
				 // Stand-alone owner creation, go back to owner list.
				// ⬇️ 关键修改 START
				switchView('property'); 
				switchPropertyTab('owner');
				// ⬆️ 关键修改 END
			}
		}


        // ===================================
        // Global App Exposure & Initialization
        // ===================================

        window.app = {
            startApp: function() {
                showLoading();
                loadData();
                renderProperties(); 
                renderTasks();
                switchView('dashboard'); 
                
                // Bind search bar for real-time filtering (Point 5)
                document.getElementById('propertySearch').addEventListener('input', window.app.filterProperties);
                
                hideLoading(); 
            },
            simpleTenantEdit: false,
            switchView: switchView,
            toggleAddMenu: toggleAddMenu,
            handleNewEntry: handleNewEntry,
            continueFormTask: continueFormTask,
            alertMessage: alertMessage,
            goBackFromForm: goBackFromForm,
            deletePropertyHandler: deletePropertyHandler,
            deleteProfileHandler: deleteProfileHandler,
            viewPropertyDetails: viewPropertyDetails,
            viewOwnerDetails: viewOwnerDetails,
            viewTenantDetails: viewTenantDetails,
            renderForm: renderForm, 
            sendRentReminder: sendRentReminder, // (Point 3)
            selectOwner: function(ownerId) { 
                document.getElementById('selectedOwnerId').value = ownerId;
                document.getElementById('formSubmitButton').disabled = false;
                document.getElementById('formSubmitButton').textContent = 'Next';
                document.querySelectorAll('.owner-select-item').forEach(item => {
                    const icon = item.querySelector('.material-icons-round');
                    if (item.getAttribute('data-owner-id') === ownerId) {
                        item.classList.add('selected');
                        icon.textContent = 'radio_button_checked';
                    } else {
                        item.classList.remove('selected');
                        icon.textContent = 'radio_button_unchecked';
                    }
                });
            },
            handleFormSubmit: handleFormSubmit, 
            updateRentLabel: updateRentLabel, 
            toggleCollapse: toggleCollapse, 
            viewDummyFile: viewDummyFile, 
            selectTenant: selectTenant, 
            checkSelectPlaceholder: checkSelectPlaceholder,
            switchPropertyTab: switchPropertyTab,
            filterProperties: filterProperties, 
            filterOwners: (filter) => { 
                const ownerListContainer = document.getElementById('ownerListContainer');
                const ownerSearch = document.getElementById('ownerSearch');
                const currentId = document.getElementById('currentId').value;
                const prop = getPropertyById(currentId);
                const currentOwnerId = prop ? prop.ownerId : null;

                const filterValue = (filter || '').toLowerCase().trim();

                if (ownerSearch) ownerSearch.value = filterValue; // Preserve filter text

                if (filterValue.length === 0) {
                     ownerListContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 10px;">Start typing above to search for owners.</p>';
                     document.getElementById('formSubmitButton').disabled = !document.getElementById('selectedOwnerId').value;

                     if (currentOwnerId || document.getElementById('selectedOwnerId').value) {
                         const targetOwnerId = document.getElementById('selectedOwnerId').value || currentOwnerId;
                         const currentOwner = getOwnerById(targetOwnerId);
                         if (currentOwner) {
                             ownerListContainer.innerHTML = `
                                  <p style="text-align: center; color: #999; padding: 10px;">Current Selection:</p>
                                  <div class="owner-select-item selected" onclick="window.app.selectOwner('${targetOwnerId}')" data-owner-id="${targetOwnerId}">
                                      <div class="owner-info">
                                          <h4>${currentOwner.fullName || 'Owner Name N/A'}</h4>
                                          <p>${currentOwner.email || currentOwner.phone || 'Contact N/A'}</p>
                                      </div>
                                      <span class="material-icons-round" style="color: #3A86FF;">radio_button_checked</span>
                                  </div>
                              `;
                          }
                     }

                     return;
                }
                
                const filteredOwners = owners.filter(o => 
                    (o.fullName && o.fullName.toLowerCase().includes(filterValue)) ||
                    (o.phone && o.phone.includes(filterValue)) ||
                    (o.email && o.email.toLowerCase().includes(filterValue))
                );

                const selectedOwnerId = document.getElementById('selectedOwnerId').value;
                
                if (filteredOwners.length === 0) {
                    ownerListContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 10px;">No matching Owners found.</p>';
                    document.getElementById('formSubmitButton').disabled = true; 
                    return;
                }

                ownerListContainer.innerHTML = filteredOwners.map(o => {
                    const isSelected = selectedOwnerId === o.id;
                    return `
                        <div class="owner-select-item ${isSelected ? 'selected' : ''}" onclick="window.app.selectOwner('${o.id}')" data-owner-id="${o.id}">
                            <div class="owner-info">
                                <h4>${o.fullName || 'Owner Name N/A'}</h4>
                                <p>${o.email || o.phone || 'Contact N/A'}</p>
                            </div>
                            <span class="material-icons-round" style="color: #3A86FF;">${isSelected ? 'radio_button_checked' : 'radio_button_unchecked'}</span>
                        </div>
                    `;
                }).join('');
                
                if (selectedOwnerId) {
                    document.getElementById('formSubmitButton').disabled = false;
                    document.getElementById('formSubmitButton').textContent = 'Next';
                }
            }
        };

        // Start the application on window load
        document.addEventListener('submit', function(ev){ ev.preventDefault(); }, true);
        document.addEventListener('click', function(ev){
            const btn = ev.target.closest('button[type="submit"]');
            if (btn) { ev.preventDefault(); window.app.handleFormSubmit(ev); }
        }, true);
        window.onload = window.app.startApp;
    </script>
</body>
</html>
