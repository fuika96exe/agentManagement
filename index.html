<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Management App (Local Storage)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="css/app.css">
</head>
<body>
    <div class="container">
        
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            Loading Data...
        </div>

        <div class="main-content">
            <div id="dashboardView" class="view" style="display: none;">
    
				<div class="home-header">
					<h1>Dashboard</h1>
					<p>Welcome back, Landlord</p>
				</div>

				<div class="action-card-row">
					
					<div class="flat-card card-blue" onclick="window.app.navigateAndAdd('property');">
						<div class="card-icon">
							<span class="material-icons-round">add_business</span>
						</div>
						<span class="card-label">Property</span>
						<span class="card-sub">Add New</span>
					</div>

					<div class="flat-card card-purple" onclick="window.app.navigateAndAdd('owner');">
						<div class="card-icon">
							<span class="material-icons-round">person_add</span>
						</div>
						<span class="card-label">Owner</span>
						<span class="card-sub">Create Profile</span>
					</div>

					<div class="flat-card card-green" onclick="window.app.navigateAndAdd('tenant');">
						<div class="card-icon">
							<span class="material-icons-round">group_add</span>
						</div>
						<span class="card-label">Tenant</span>
						<span class="card-sub">New Lease</span>
					</div>

				</div>
				<div class="task-section">
					<h2>Your Tasks</h2> <div id="taskList" class="task-list">
					</div>
				</div>
			</div>

            <div id="propertyView" class="view" style="display: none;">
                <div class="property-header">
                    <div class="search-container">
                        <span class="material-icons-round search-icon">search</span>
                        <input type="text" id="propertySearch" placeholder="Search properties, tenants, or owners...">

                        <div id="addMenu" class="add-menu">
                            <a href="#" onclick="window.app.handleNewEntry('property'); return false;">
                                <span class="material-icons-round" style="font-size: 18px;">home</span> New Property
                            </a>
                            <a href="#" onclick="window.app.handleNewEntry('owner'); return false;">
                                <span class="material-icons-round" style="font-size: 18px;">person</span> New Owner
                            </a>
                            <a href="#" onclick="window.app.handleNewEntry('tenant'); return false;">
                                <span class="material-icons-round" style="font-size: 18px;">group</span> New Tenant
                            </a>
                        </div>
                    </div>
                </div>

                <div class="tab-bar">
                    <a href="#" id="tabProperty" class="active-tab" onclick="window.app.switchPropertyTab('property'); return false;">Property</a>
                    <a href="#" id="tabOwner" onclick="window.app.switchPropertyTab('owner'); return false;">Owner</a>
                    <a href="#" id="tabTenant" onclick="window.app.switchPropertyTab('tenant'); return false;">Tenant</a>
                </div>
                
                <div id="tabContentProperty" class="tab-content property-list" style="display: flex;">
                    </div>
                <div id="tabContentOwner" class="tab-content property-list" style="display: none;">
                    </div>
                <div id="tabContentTenant" class="tab-content property-list" style="display: none;">
                    </div>
            </div>
            
            <div id="formView" class="view" style="display: none;">
                <div class="property-header">
                    <a href="#" id="formBackBtn" class="back-btn" onclick="window.app.goBackFromForm(); event.stopPropagation(); return false;">
                        <span class="material-icons-round">arrow_back_ios</span>
                        Back
                    </a>
                </div>

                <div class="form-view-content">
                    <h2 id="formTitle" style="margin-top: 5px;"></h2>

                    <form id="dataEntryForm">
                        <input type="hidden" id="currentFormType" name="type" value=""> <input type="hidden" id="currentFormPhase" name="phase" value="0">
                        <input type="hidden" id="currentId" name="id" value=""> <input type="hidden" id="selectedOwnerId" name="ownerId" value="">
                        <input type="hidden" id="selectedTenantId" name="tenantId" value="">

                        <div id="formFields">
                            </div>
                    </form>
                </div>
            </div>

            <div id="detailView" class="view" style="display: none;">
                <div class="property-header">
                    <a href="#" class="back-btn" onclick="window.app.switchView('property'); window.app.switchPropertyTab('property'); return false;" style="margin: 0; padding: 0;">
                        <span class="material-icons-round">arrow_back_ios</span>
                        Property List
                    </a>
                    <div class="header-content">
                        <h2 id="detailPropertyName" style="margin: 10px 0 0; font-size: 24px; font-weight: 700; flex-grow: 1;">Property Name</h2>
                        <button id="detailEditBtn" class="add-btn" onclick="/* Set by JS function */">
                            <span class="material-icons-round" style="font-size: 22px;">edit</span>
                        </button>
                    </div>
                </div>
                <div id="detailContent" class="form-view-content" style="padding-top: 5px;">
                    </div>
                <div class="detail-footer">
                    <button class="delete-main-btn" onclick="window.app.deletePropertyHandler(document.getElementById('currentId').value, document.getElementById('detailPropertyName').textContent); return false;">
                        Delete Property
                    </button>
                </div>
            </div>
            
            <div id="ownerDetailView" class="view" style="display: none;">
                <div class="property-header">
                    <a href="#" class="back-btn" onclick="window.app.switchView('property'); window.app.switchPropertyTab('owner'); return false;" style="margin: 0; padding: 0;">
                        <span class="material-icons-round">arrow_back_ios</span>
                        Owner List
                    </a>
                    <div class="header-content">
                        <h2 id="detailOwnerName" style="margin: 10px 0 0; font-size: 24px; font-weight: 700; flex-grow: 1;">Owner Name</h2>
                        <button id="ownerEditBtn" class="add-btn" onclick="">
                            <span class="material-icons-round" style="font-size: 22px;">edit</span>
                        </button>
                    </div>
                </div>
                <div id="ownerDetailContent" class="form-view-content" style="padding-top: 5px;">
                    </div>
                <div class="detail-footer">
                    <button class="delete-main-btn" onclick="window.app.deleteProfileHandler(document.getElementById('currentId').value, 'owner', document.getElementById('detailOwnerName').textContent); return false;">
                        Delete Owner Profile
                    </button>
                </div>
            </div>

            <div id="tenantDetailView" class="view" style="display: none;">
                <div class="property-header">
                    <a href="#" class="back-btn" onclick="window.app.switchView('property'); window.app.switchPropertyTab('tenant'); return false;" style="margin: 0; padding: 0;">
                        <span class="material-icons-round">arrow_back_ios</span>
                        Tenant List
                    </a>
                    <div class="header-content">
                        <h2 id="detailTenantName" style="margin: 10px 0 0; font-size: 24px; font-weight: 700; flex-grow: 1;">Tenant Name</h2>
                        <button id="tenantEditBtn" class="add-btn" onclick="">
                            <span class="material-icons-round" style="font-size: 22px;">edit</span>
                        </button>
                    </div>
                </div>
                <div id="tenantDetailContent" class="form-view-content" style="padding-top: 5px;">
                    </div>
                <div class="detail-footer">
                    <button class="delete-main-btn" onclick="window.app.deleteProfileHandler(document.getElementById('currentId').value, 'tenant', document.getElementById('detailTenantName').textContent); return false;">
                        Delete Tenant Profile
                    </button>
                </div>
            </div>

        </div>

        <div class="navbar">
            <a href="#" id="navDashboard" class="active" onclick="window.app.switchView('dashboard'); return false;">
                <span class="material-icons-round">home</span>
                Home
            </a>
            <a href="#" id="navProperty" onclick="window.app.switchView('property'); window.app.switchPropertyTab('property'); return false;">
                <span class="material-icons-round">apartment</span>
                Property
            </a>
            <a href="#" onclick="window.app.alertMessage('Navigating to Services page...', 'info'); return false;">
                <span class="material-icons-round">apps</span>
                Services
            </a>
            <a href="#" onclick="window.app.alertMessage('Navigating to More page...', 'info'); return false;">
                <span class="material-icons-round">more_horiz</span>
                More
            </a>
        </div>
    </div>
    
    <div id="appMessageBox" class="app-message-box"></div>
    
    <div id="confirmModal" style="display: none;" class="modal-overlay">
        <div class="modal-content">
            <h3 id="confirmModalTitle">Confirm Deletion</h3>
            <p id="confirmModalMessage"></p>
            <div class="modal-actions">
                <button id="confirmModalCancel" class="btn-cancel">Cancel</button>
                <button id="confirmModalConfirm" class="btn-confirm">Delete</button>
            </div>
        </div>
    </div>

	<div id="quickOwnerModal" class="modal-overlay" style="display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); z-index: 10000;">
        <div class="quick-link-content">
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0; font-size: 18px; font-weight: 700;">New Owner Profile</h3>
                <span class="material-icons-round" onclick="document.getElementById('quickOwnerModal').style.display='none'" style="cursor: pointer; color: #ccc; padding: 5px;">close</span>
            </div>
            
            <p style="font-size: 13px; color: #666; margin: 0 0 15px 0;">Please fill in the complete details below.</p>

            <form id="quickOwnerForm" onsubmit="window.app.handleQuickOwnerSubmit(event)">
                
                <div class="form-section-title">Basic Info</div>
                
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="font-size: 13px; color: #444; margin-bottom: 4px; display: block; font-weight: 500;">Full Name <span style="color:red">*</span></label>
                    <input type="text" id="qo-name" name="fullName" required placeholder="Full Name" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; outline: none;">
                </div>

                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="font-size: 13px; color: #444; margin-bottom: 4px; display: block; font-weight: 500;">Phone Number <span style="color:red">*</span></label>
                    <input type="tel" id="qo-phone" name="phone" required placeholder="012-3456789" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; outline: none;">
                </div>

                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="font-size: 13px; color: #444; margin-bottom: 4px; display: block; font-weight: 500;">Email Address</label>
                    <input type="email" id="qo-email" name="email" placeholder="email@example.com" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; outline: none;">
                </div>
                
                <div class="form-section-title" style="margin-top: 20px;">Financial & Address</div>

                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="font-size: 13px; color: #444; margin-bottom: 4px; display: block; font-weight: 500;">Bank Details <span style="color:red">*</span></label>
                    <input type="text" id="qo-bank" name="bankDetails" required placeholder="Bank Name & Account No." 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; outline: none;">
                </div>

                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="font-size: 13px; color: #444; margin-bottom: 4px; display: block; font-weight: 500;">Mgmt Fee (%)</label>
                    <input type="number" id="qo-fee" name="managementFee" placeholder="e.g. 10" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; outline: none;">
                </div>

                <div class="form-group" style="margin-bottom: 25px;">
                    <label style="font-size: 13px; color: #444; margin-bottom: 4px; display: block; font-weight: 500;">Mailing Address</label>
                    <textarea id="qo-address" name="address" rows="2" placeholder="Full Address"
                              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; outline: none; resize: none; font-family: inherit;"></textarea>
                </div>

                <button type="submit" class="submit-btn" style="width: 100%; background-color: #3A86FF;">Create & Select</button>
            </form>

        </div>
    </div>

	<div id="quickLinkModal" class="modal-overlay" style="display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); z-index: 9999;">
        
        <div class="quick-link-content">
            
            <div id="quickLinkListState" style="display: flex; flex-direction: column; max-height: 70vh;"> 
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 18px; font-weight: 700;">Link Tenant</h3>
                    <span class="material-icons-round" onclick="window.app.closeQuickLinkModal()" style="cursor: pointer; color: #ccc; font-size: 22px; padding: 5px;">close</span>
                </div>

                <div style="position: relative; margin-bottom: 10px;">
                    <span class="material-icons-round" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #999; font-size: 20px;">search</span>
                    <input type="text" id="quickLinkSearch" placeholder="Search name..." 
                           oninput="window.app.filterQuickLinkTenants(this.value)"
                           style="width: 100%; padding: 10px 10px 10px 38px; border: 1px solid #eee; background-color: #f9f9f9; border-radius: 10px; font-size: 15px; box-sizing: border-box; outline: none; color: #333; transition: border-color 0.2s;">
                </div>

                <div id="quickLinkListContainer" style="overflow-y: auto; min-height: 100px; padding-right: 2px;">
                    </div>
            </div>

            <div id="quickLinkConfirmState" style="display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 10px 0;">
                <div style="width: 60px; height: 60px; background: #e8f5e9; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                    <span class="material-icons-round" style="font-size: 30px; color: #155724;">person_add</span>
                </div>
                <h3 style="margin: 0 0 8px 0; font-size: 18px;">Confirm Link</h3>
                
                <p style="color: #666; margin-bottom: 25px; font-size: 15px; line-height: 1.6;">
                    Link <b id="quickLinkTenantName" style="color: #333;">Tenant</b><br>
                    to <b id="quickLinkPropName" style="color: #3A86FF;">Property Name</b>?
                </p>
                
                <div style="display: flex; gap: 10px; width: 100%;">
                    <button class="submit-btn" style="background-color: #fff; border: 1px solid #ddd; color: #666; flex: 1;" onclick="window.app.switchQuickLinkState('list')">Cancel</button>
                    <button id="btnConfirmQuickLink" class="submit-btn" style="background-color: #28a745; flex: 1; border: 1px solid #28a745;">Confirm</button>
                </div>
            </div>

        </div>
    </div>


	<style>
        /* 蓝色确认按钮样式，用于非删除类的确认操作 */
        .btn-primary-modal {
            background-color: #3A86FF !important; /* 强制覆盖原本的红色 */
            color: white;
        }
        .btn-primary-modal:hover {
            background-color: #2e6ad9 !important;
        }
    </style>

    <script>
        
        let properties = [];
        let tasks = [];
        let owners = []; 
        let tenants = []; 
        let currentUserId = 'local_user_123'; 
        
        // MALAYSIAN STATES for select dropdown
        const MALAYSIAN_STATES = [
            "Johor", "Kedah", "Kelantan", "Melaka", "Negeri Sembilan", "Pahang", 
            "Penang", "Perak", "Perlis", "Sabah", "Sarawak", "Selangor", "Terengganu",
            "Kuala Lumpur", "Labuan", "Putrajaya"
        ];
        
        // HOUSE TYPES for select dropdown
        const HOUSE_TYPES = [
            "Apartment", "Condo", "Landed House", "Studio", "Duplex", "Townhouse", "Shop Lot"
        ];
        
        // RENTAL TYPES for select dropdown (Removed Chinese for consistency)
        const RENTAL_TYPES = [
            {val: 'whole_unit', label: 'Whole Unit Rental'},
            {val: 'room_by_room', label: 'Room-by-Room Rental'}
        ];
        
        // Rent Reminder Message (Point 3)
        const RENT_REMINDER_MESSAGE = "Kindly reminder: Your rent is due on the 1st of this month. Please make the payment promptly. Thank you!";
        
        // Rent Reminder Date (Point 3)
        const RENT_REMINDER_DAY = 4;


        // ===================================
        // Utility: Local Storage Management
        // ===================================
        
        function loadData() {
            const storedProperties = localStorage.getItem('properties');
            properties = storedProperties ? JSON.parse(storedProperties) : [];
            
            const storedTasks = localStorage.getItem('tasks');
            tasks = storedTasks ? JSON.parse(storedTasks) : [];
            
            const storedOwners = localStorage.getItem('owners');
            owners = storedOwners ? JSON.parse(storedOwners) : [];

            const storedTenants = localStorage.getItem('tenants');
            tenants = storedTenants ? JSON.parse(storedTenants) : [];
            
            console.log("Data loaded from localStorage.");
        }

        function saveData() {
            localStorage.setItem('properties', JSON.stringify(properties));
            localStorage.setItem('tasks', JSON.stringify(tasks));
            localStorage.setItem('owners', JSON.stringify(owners));
            localStorage.setItem('tenants', JSON.stringify(tenants));
            console.log("Data saved to localStorage.");
            
            // Re-render based on current active tab
            if (currentView === 'property') {
                renderProperties();
                renderOwners();
                renderTenants();
            } else if (currentView === 'dashboard') {
                renderTasks();
            }
        }
        
        // ===================================
        // Utility: Message Box & Confirmation
        // ===================================

        const messageBox = document.getElementById('appMessageBox');
        const loadingOverlay = document.getElementById('loadingOverlay');
        let messageTimer;

        function showLoading() { loadingOverlay.style.display = 'flex'; }
        function hideLoading() { loadingOverlay.style.display = 'none'; }

        function alertMessage(message, type = 'info') {
            clearTimeout(messageTimer);

            messageBox.textContent = message;
            messageBox.className = `app-message-box ${type}`;
            
            requestAnimationFrame(() => {
                messageBox.classList.add('visible');
            });

            messageTimer = setTimeout(() => {
                messageBox.classList.remove('visible');
            }, 3000);
        }
        
        // Confirmation Modal Logic 
        let confirmCallback = null;

        function showConfirmation(title, message, callback, confirmBtnText = 'Delete', confirmBtnClass = 'btn-confirm') {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalMessage').textContent = message;
            
            const confirmBtn = document.getElementById('confirmModalConfirm');
            confirmBtn.textContent = confirmBtnText; // 设置按钮文字
            confirmBtn.className = confirmBtnClass;  // 设置按钮颜色样式
            
            confirmCallback = callback;
            document.getElementById('confirmModal').style.display = 'flex';
        }

        function hideConfirmation() {
            document.getElementById('confirmModal').style.display = 'none';
            confirmCallback = null;
        }

        document.getElementById('confirmModalCancel').onclick = hideConfirmation;
        document.getElementById('confirmModalConfirm').onclick = () => {
            if (confirmCallback) {
                confirmCallback(true);
            }
            hideConfirmation();
        };

        // ===================================
        // View Control and Navigation
        // ===================================
        let currentView = 'dashboard';
        let currentPropertyTab = 'property'; // State for the current tab in propertyView
        
        function switchView(viewName) {
            currentView = viewName;
            
            document.querySelectorAll('.view').forEach(view => {
                view.style.display = 'none';
            });

            const targetView = document.getElementById(viewName + 'View');
            const detailViews = ['detail', 'ownerDetail', 'tenantDetail'];

            if (targetView) {
                targetView.style.display = 'flex'; 
                targetView.style.flexDirection = 'column';
            } else if (detailViews.includes(viewName)) {
                // Handle new detail views
                document.getElementById(viewName + 'View').style.display = 'flex';
                document.getElementById(viewName + 'View').style.flexDirection = 'column';
            }
            
            document.querySelector('.main-content').style.paddingBottom = '70px'; 

            document.querySelectorAll('.navbar a').forEach(link => link.classList.remove('active'));
            if (viewName === 'dashboard') {
                document.getElementById('navDashboard').classList.add('active');
                // Ensure tasks are rendered when navigating to dashboard
                try { renderTasks(); } catch (e) { console.warn('renderTasks error:', e); }
            } else if (['property', 'form', 'detail', 'ownerDetail', 'tenantDetail'].includes(viewName)) { 
                document.getElementById('navProperty').classList.add('active');
                toggleAddMenu(false); 
                // When switching to property-level views, refresh the lists
                if (viewName === 'property') {
                    try {
                        renderProperties();
                        renderOwners();
                        renderTenants();
                    } catch (e) { console.warn('render property tabs error:', e); }
                }
            } 
        }

        function switchPropertyTab(tabName) {
            currentPropertyTab = tabName;
            document.querySelectorAll('.tab-bar a').forEach(link => link.classList.remove('active-tab'));
            document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active-tab');

            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            document.getElementById(`tabContent${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).style.display = 'flex';

            // Ensure the correct data is rendered when switching tabs
            if (tabName === 'property') renderProperties();
            if (tabName === 'owner') renderOwners();
            if (tabName === 'tenant') renderTenants();
        }

        /**
         * Toggles the visibility of a detail card and rotates the icon (Point 2)
         */
        function toggleCollapse(elementId) {
            const content = document.getElementById(elementId);
            const icon = document.getElementById(elementId + 'Icon');

            if (!content || !icon) return;

            const isVisible = content.style.display !== 'none';

            if (isVisible) {
                content.style.display = 'none';
                icon.classList.remove('rotate');
            } else {
                content.style.display = 'flex';
                content.style.flexWrap = 'wrap'; 
                icon.classList.add('rotate');
            }
        }

        function goBackFromForm() {
            const currentFormType = document.getElementById('currentFormType').value;
            const currentPhase = document.getElementById('currentFormPhase').value;
            const currentId = document.getElementById('currentId').value;
            
            if (currentFormType === 'owner') {
				// 如果是从 Property 页面创建房产流程中跳转过来的，还是回 Property 表单
				const selectedOwnerIdField = document.getElementById('selectedOwnerId');
				if (selectedOwnerIdField.value && selectedOwnerIdField.value.startsWith('prop-')) {
					renderForm(selectedOwnerIdField.value, 0, 'property');
					return;
				}

				// 新逻辑：检查这个 Owner 是否已存在于数据库
				// 如果不存在 (undefined)，说明是正在“新建”，点击 Back 应该回 Dashboard
				if (!getOwnerById(currentId)) {
					switchView('dashboard');
					return;
				}

				// 如果存在，说明是“编辑”，Back 回列表
				switchView('property');
				switchPropertyTab('owner');
				return;
			}
			
			// ========== 修改 2: Tenant 返回逻辑 ==========
			if (currentFormType === 'tenant') {
				const tenant = getTenantById(currentId);
				
				// 新逻辑：如果是“新建” (数据库里还没这个人)，或者处于 Phase 0 (刚开始填资料)，Back 回 Dashboard
				// 注意：Tenant 是分步保存的，如果是 Phase 1/2/3 点击 Back，通常还是回列表比较安全，
				// 但如果只是刚点进来 Phase 0 还没保存，绝对应该回 Dashboard。
				if (!tenant) {
					switchView('dashboard');
					return;
				}

				// 原有逻辑：如果是已完成设置的租客，返回详情页
				if (tenant && tenant.phase >= 4) {
					viewTenantDetails(currentId);
					return;
				}
				
				// 其他情况 (比如编辑进行中的租客)，返回列表
				switchView('property');
				switchPropertyTab('tenant');
				return;
			}
            
            if (currentFormType === 'property') {
                if (currentPhase === '3') {
                    viewPropertyDetails(currentId);
                    return;
                }
                if (currentPhase === '2') {
                    renderForm(currentId, 1, 'property');
                    return;
                }
                if (currentPhase === '1') {
                    renderForm(currentId, 0, 'property');
                    return;
                }
                if (currentPhase === '0') {
                    const prop = getPropertyById(currentId);
                    if (prop && !prop.ownerId) {
                        properties = properties.filter(p => p.id !== currentId);
                        tasks = tasks.filter(t => t.propId !== currentId);
                        saveData();
                        alertMessage('New Property creation cancelled.', 'info');
                    }
                    switchView('dashboard');
                    return;
                }
            }
            
            switchView('dashboard');
        }
        
        function toggleAddMenu(force) {
            const menu = document.getElementById('addMenu');
            const isVisible = menu.classList.contains('visible');
            
            let shouldBeVisible = (typeof force === 'boolean') ? force : !isVisible;
            
            if (shouldBeVisible) {
                menu.classList.add('visible');
            } else {
                menu.classList.remove('visible');
            }
        }
        
        // --- Added for Tenant/Owner Handling ---
        function handleNewEntry(type) {
             toggleAddMenu(false);
			 let newId;
			 if (type === 'property') { // <-- 确保 type 匹配 'property'
				 newId = `prop-${Date.now()}`;
				 // Start with Phase 0 for Owner selection
				 renderForm(newId, 0, 'property'); // <-- 必须调用 renderForm
				 // Create initial property task
				 
			 } else if (type === 'owner') {
                 newId = `owner-${Date.now()}`;
                 renderForm(newId, 0, 'owner'); 
             } else if (type === 'tenant') {
                  newId = `tenant-${Date.now()}`;
                  // Tenant creation starts at phase 0
                  renderForm(newId, 0, 'tenant');
             }
         }
         
         function continueFormTask(id, isEditMode, type) {
			// ⬇️ MODIFICATION START: Add Debug Log for Entry Point
			console.log(`DEBUG: Entering continueFormTask. ID: ${id}, isEditMode: ${isEditMode}, Type: ${type}`);
			// ⬆️ MODIFICATION END
			
			let currentPhase;
			if (type === 'property') {
			   const prop = getPropertyById(id);
			   currentPhase = prop ? (prop.phase || 0) : 0;
			   
			   // ⬇️ MODIFICATION START: Add Debug Log for Phase Check
			   console.log(`DEBUG: Property Phase Check. Current Phase: ${currentPhase}`);
			   // ⬆️ MODIFICATION END
			   
			   // If it's a full detail edit (phase 3), force to phase 3 form (Point 1)
			   // 【关键修改】我们强制让 'isEditMode' 忽略 Phase 检查，直接进入 Phase 3 全面编辑表单
			   if(isEditMode) { // <-- 简化判断条件，只要是编辑模式就进入 Phase 3
				   console.log("DEBUG: Forcing transition to Phase 3 Full Edit Form.");
				   renderForm(id, 3, 'property');
				   return;
			   }
             } else if (type === 'tenant') {
                 const tenant = getTenantById(id);
                 currentPhase = tenant ? (tenant.phase || 0) : 0;
                 // If editing a completed tenant, enable simple edit on phase 0 only
                 if (isEditMode && tenant && tenant.phase >= 3) {
                     window.app.simpleTenantEdit = true;
                     renderForm(id, 0, 'tenant');
                     return;
                 }
                 // If the tenant is incomplete, continue multi-step flow
                 if (currentPhase >= 3) currentPhase = 0;
                 const task = getTaskByTenantId(id);
                 if (task) currentPhase = task.phase;
             } else if (type === 'owner') {
                 // Owners do not have phases, always edit (Point 4)
                 renderForm(id, 0, 'owner');
                 return;
             }
             renderForm(id, currentPhase, type);
         }

        // ===================================
        // Detail View Navigators
        // ===================================

        function viewPropertyDetails(propId) {
			const prop = getPropertyById(propId);
			if (!prop || prop.phase < 3) return;
			const owner = getOwnerById(prop.ownerId); 
			const tenant = getTenantById(prop.tenantId); 
			
			document.getElementById('currentId').value = propId;
			renderPropertyDetailsContent(prop, owner, tenant); 
			
			// ⬇️ MODIFICATION START: Use getElementById once and add a console log for debugging
			const editBtn = document.getElementById('detailEditBtn'); // Get the button element
			
			if (editBtn) {
				// Log to confirm the code execution
				console.log(`DEBUG: Binding Edit Button for Property ID: ${prop.id}`); 
				
				// Bind the handler explicitly
				editBtn.onclick = function(event) { 
					event.preventDefault(); // Prevent any default action just in case
					console.log("DEBUG: Edit Button Clicked. Executing continueFormTask.");
					window.app.continueFormTask(prop.id, true, 'property'); 
					return false; 
				};
			} else {
				console.error("ERROR: Detail Edit Button element not found!");
			}
			// ⬆️ MODIFICATION END
			
			switchView('detail');
		}

        function viewOwnerDetails(ownerId) {
            const owner = getOwnerById(ownerId);
            if (!owner) return;
            
            document.getElementById('currentId').value = ownerId;
            renderOwnerDetailView(owner);
            switchView('ownerDetail');
        }

        function viewTenantDetails(tenantId) {
            const tenant = getTenantById(tenantId);
            if (!tenant) return;
            
            document.getElementById('currentId').value = tenantId;
            renderTenantDetailView(tenant);
            switchView('tenantDetail');
        }

        function deletePropertyHandler(propId, propName) {
            const displayName = propName && propName.trim() !== '' ? propName : 'this property';
            showConfirmation(
                'Confirm Deletion',
                `Are you sure you want to permanently delete the information for: ${displayName}? This action cannot be undone.`,
                (confirmed) => {
                    if (confirmed) {
                        deleteProperty(propId, displayName);
                        switchView('property');
                        switchPropertyTab('property');
                    }
                }
            );
        }

        function deleteProfileHandler(id, type, name) {
             const displayName = name && name.trim() !== '' ? name : `this ${type} profile`;
             const associatedProperties = properties.filter(p => p[`${type}Id`] === id);

             if (associatedProperties.length > 0) {
                 const propNames = associatedProperties.map(p => p.name).join(', ');
                 alertMessage(`Cannot delete ${type} profile. It is still linked to property/properties: ${propNames}.`, 'error');
                 return;
             }

             showConfirmation(
                'Confirm Deletion',
                `Are you sure you want to permanently delete the profile for: ${displayName}? This action cannot be undone.`,
                (confirmed) => {
                    if (confirmed) {
                        if (type === 'owner') {
                            owners = owners.filter(o => o.id !== id);
                            saveData();
                            switchView('property');
                            switchPropertyTab('owner');
                            alertMessage(`${displayName} deleted successfully.`, 'success');
                        } else if (type === 'tenant') {
                             tenants = tenants.filter(t => t.id !== id);
                             tasks = tasks.filter(t => t.tenantId !== id); // Remove associated tasks
                             saveData();
                             switchView('property');
                             switchPropertyTab('tenant');
                             alertMessage(`${displayName} deleted successfully.`, 'success');
                        }
                    }
                }
            );
        }
        
        function viewDummyFile(fileName) {
            alertMessage(`Simulating file view for: ${fileName}`, 'info');
        }
        
        // Rent Reminder Logic (Point 3)
        function sendRentReminder(taskId, propId) {
             const prop = getPropertyById(propId);
             const tenant = getTenantById(prop.tenantId);
             const propName = prop.name;
             const tenantName = tenant ? tenant.fullName : 'Tenant';
            
             // Copy message to clipboard
             const message = RENT_REMINDER_MESSAGE.replace('Tenant Name', tenantName).replace('Property Name', propName);
             navigator.clipboard.writeText(message).then(() => {
                 alertMessage(`Reminder message for ${propName} copied to clipboard! Task updated.`, 'success');

                 // 1. Mark current task as completed
                 const taskIndex = tasks.findIndex(t => t.id === taskId);
					 if (taskIndex !== -1) {
						 tasks[taskIndex].status = 'completed'; // <-- 必须确保这行代码正确执行
						 tasks[taskIndex].completedDate = new Date().toISOString().split('T')[0];
                     
                     // 2. Generate a new recurring task for the next month
                     const now = new Date();
                     const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, RENT_REMINDER_DAY); // Next 4th day
                     const nextMonthString = nextMonth.toISOString().split('T')[0];
                     
                     const nextTaskId = `rent-${propId}-${nextMonth.getFullYear()}-${nextMonth.getMonth() + 1}`;
                     
                     updateTaskData(nextTaskId, { 
                         id: nextTaskId, 
                         type: 'rent_reminder', 
                         propId: propId, 
                         isRent: true,
                         sendDate: nextMonthString, 
                         description: `Collect Rent for ${propName}`, 
                         details: `Due on 1st, Send reminder on ${nextMonthString}.`, 
                         status: 'in_progress', 
                         userId: currentUserId 
                     });

                     saveData();
                 }
                 renderTasks();

             }).catch(err => {
                 console.error('Could not copy text: ', err);
                 alertMessage('Failed to copy message to clipboard.', 'error');
             });
        }
        
        // Generates the first rent reminder task for a newly assigned tenant (Point 3)
        function createFirstRentTask(propId, propName) {
            const now = new Date();
            const nextMonth = new Date(now.getFullYear(), now.getMonth(), RENT_REMINDER_DAY);
            
            // If today is past the 4th, set the task for the next month
            if (now.getDate() > RENT_REMINDER_DAY) {
                 nextMonth.setMonth(now.getMonth() + 1);
            }
            // Ensure day is 4th
            nextMonth.setDate(RENT_REMINDER_DAY);

            const nextMonthString = nextMonth.toISOString().split('T')[0];
            const nextTaskId = `rent-${propId}-${nextMonth.getFullYear()}-${nextMonth.getMonth() + 1}`;
            
            // Check if task already exists to prevent duplication on edit save
            if (tasks.some(t => t.id === nextTaskId)) return;
            
            updateTaskData(nextTaskId, { 
                id: nextTaskId, 
                type: 'rent_reminder', 
                propId: propId, 
                isRent: true,
                sendDate: nextMonthString, 
                description: `Collect Rent for ${propName}`, 
                details: `Due on 1st, Send reminder on ${nextMonthString}.`, 
                status: 'in_progress', 
                userId: currentUserId 
            });
        }


        // ===================================
        // Local Data Logic (getters/updaters)
        // ===================================
        function getTaskByPropId(propId) { return tasks.find(t => t.propId === propId && t.type === 'property'); }
        function getTaskByTenantId(tenantId) { return tasks.find(t => t.tenantId === tenantId && t.type === 'tenant_setup'); }
        function getPropertyById(propId) { return properties.find(p => p.id === propId); }
        function getOwnerById(ownerId) { return owners.find(o => o.id === ownerId); }
        function getTenantById(tenantId) { return tenants.find(t => t.id === tenantId); }
        
        function updatePropertyData(propId, data) {
            let propIndex = properties.findIndex(p => p.id === propId);
            if (propIndex === -1) { properties.push({ id: propId, ...data }); } 
            else { properties[propIndex] = { ...properties[propIndex], ...data }; }
            saveData();
            return true;
        }

        function updateTaskData(taskId, data) {
            let taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) { tasks.push({ id: taskId, ...data }); } 
            else { tasks[taskIndex] = { ...tasks[taskIndex], ...data }; }
            saveData();
            return true;
        }

        function saveOwnerData(ownerId, data) {
            let ownerIndex = owners.findIndex(o => o.id === ownerId);
            if (ownerIndex === -1) { owners.push({ id: ownerId, ...data }); } 
            else { owners[ownerIndex] = { ...owners[ownerIndex], ...data }; }
            saveData();
            return true;
        }

        function saveTenantData(tenantId, data) {
            let tenantIndex = tenants.findIndex(t => t.id === tenantId);
            if (tenantIndex === -1) { tenants.push({ id: tenantId, ...data }); } 
            else { tenants[tenantIndex] = { ...tenants[tenantIndex], ...data }; }
            saveData();
            return true;
        }

        function deleteProperty(propId, propName) {
            showLoading();
            try {
                properties = properties.filter(p => p.id !== propId);
                tasks = tasks.filter(t => t.propId !== propId);
                saveData(); 
                alertMessage(`Property "${propName}" deleted successfully.`, 'success');
            } catch (error) {
                console.error("Error deleting property:", error);
                alertMessage('Failed to delete property and associated task.', 'error');
            } finally {
                hideLoading(); 
            }
        }


        // ===================================
        // Rendering Functions (Tabs)
        // ===================================
        
        function renderTasks() {
			const taskList = document.getElementById('taskList');
			taskList.innerHTML = ''; // 清空列表
			
			// 1. 获取当前数据状态
			const hasProperty = properties.length > 0;
			const hasOwner = owners.length > 0;
			const hasTenant = tenants.length > 0;

			// 2. 获取用户是否已经手动点过“完成” (从 localStorage 读取)
			const propDone = localStorage.getItem('setup_property_done') === 'true';
			const ownerDone = localStorage.getItem('setup_owner_done') === 'true';
			const tenantDone = localStorage.getItem('setup_tenant_done') === 'true';

			// 3. 定义一个生成新手任务 HTML 的辅助函数
			function createOnboardingHTML(type, title, desc, hasData, isDoneFlag) {
				// 如果已经点过完成了，就不生成 HTML
				if (isDoneFlag) return ''; 

				// 状态 A: 用户已经加了数据，但还没点完成 -> 显示“求表扬”状态
				if (hasData) {
					return `
						<div class="task-item ready-to-complete" onclick="window.app.completeOnboardingTask('${type}')">
							<span class="material-icons-round icon" style="color: #28a745;">check_circle</span>
							<div class="task-info">
								<h3 style="color: #155724; text-decoration: line-through;">${title}</h3>
								<p style="color: #28a745; font-weight: 600;">Ready to complete! Tap to finish.</p>
							</div>
							<button class="action-btn btn-success" onclick="window.app.completeOnboardingTask('${type}'); event.stopPropagation();">
								Finish
							</button>
						</div>
					`;
				}

				// 状态 B: 用户还没加数据 -> 显示“去开始”状态
				return `
					<div class="task-item incomplete" onclick="window.app.navigateAndAdd('${type}')">
						<span class="material-icons-round icon" style="color: #3A86FF;">radio_button_unchecked</span>
						<div class="task-info">
							<h3>${title}</h3>
							<p>${desc}</p>
						</div>
						<button class="action-btn" onclick="window.app.navigateAndAdd('${type}'); event.stopPropagation();">
							Start
						</button>
					</div>
				`;
			}

			// 4. 生成三个任务的 HTML
			let onboardingHTML = '';
			onboardingHTML += createOnboardingHTML('property', 'Add 1st Property!', 'Create a property to track expenses.', hasProperty, propDone);
			onboardingHTML += createOnboardingHTML('owner', 'Add 1st Owner!', 'Set up who owns the property.', hasOwner, ownerDone);
			onboardingHTML += createOnboardingHTML('tenant', 'Add 1st Tenant!', 'Register a tenant to track leases.', hasTenant, tenantDone);

			// 5. 将新手任务插入列表
			taskList.innerHTML += onboardingHTML;

			// --- 下面是原本的普通任务渲染逻辑 ---
			
			const now = new Date();
			const todayDate = now.toISOString().split('T')[0];
			
			// 筛选普通任务
			const pendingTasks = tasks.filter(t => 
				t.status === 'in_progress' && (t.type !== 'rent_reminder' || t.sendDate <= todayDate)
			).sort((a, b) => {
				 if (a.isRent && !b.isRent) return -1;
				 if (!a.isRent && b.isRent) return 1;
				 return 0;
			});

			// 如果既没有新手任务，也没有普通任务，显示 "All Clear"
			if (onboardingHTML === '' && pendingTasks.length === 0) {
				taskList.innerHTML = `
					<div class="task-item">
						<span class="material-icons-round icon" style="color: #6c757d;">check_circle_outline</span>
						<div class="task-info">
							<h3>No Tasks</h3>
							<p>All outstanding tasks are complete!</p>
						</div>
					</div>
				`;
				return;
			}

			// 渲染普通任务
			pendingTasks.forEach(task => {
				// ... (把你原本 renderTasks 里的 forEach 代码复制到这里) ...
				// ... 注意：如果你之前有改动过 button 逻辑，请保持你的最新版本 ...
				
				let taskDescription = task.description;
				// ... (省略重复代码，保持你现有的逻辑即可) ...
				let buttonAction = '';
				// 简写示例：
				if (task.type === 'property') buttonAction = `window.app.continueFormTask('${task.propId}', false, 'property')`;
				else if (task.type === 'tenant_setup') buttonAction = `window.app.continueFormTask('${task.tenantId}', false, 'tenant')`;
				else if (task.type === 'rent_reminder') buttonAction = `window.app.sendRentReminder('${task.id}', '${task.propId}')`;

				taskList.innerHTML += `
					<div class="task-item incomplete" onclick="${buttonAction}">
						<span class="material-icons-round icon">edit_note</span>
						<div class="task-info">
							<h3>${taskDescription}</h3>
							<p>${task.details || ''}</p>
						</div>
						<a href="#" class="action-btn">Action</a>
					</div>
				`;
			});
		}
        
        // Caches property list when running filter
        let currentProperties = [];

        function filterProperties() {
            const searchTerm = (document.getElementById('propertySearch')?.value || '').toLowerCase().trim();
            if (!searchTerm) {
                currentProperties = properties;
                renderPropertiesList(currentProperties);
                return;
            }

            // Fixed filter logic (Point 5)
            currentProperties = properties.filter(p => {
                const owner = getOwnerById(p.ownerId);
                const tenant = getTenantById(p.tenantId);

                return (
                    (p.name && p.name.toLowerCase().includes(searchTerm)) ||
                    (owner && owner.fullName && owner.fullName.toLowerCase().includes(searchTerm)) ||
                    (tenant && tenant.fullName && tenant.fullName.toLowerCase().includes(searchTerm))
                );
            });

            renderPropertiesList(currentProperties);
        }

        function renderPropertiesList(list) {
            const listContainer = document.getElementById('tabContentProperty');
            listContainer.innerHTML = '';
            
            const searchTerm = document.getElementById('propertySearch')?.value.trim();

            // 空状态处理 (保持不变)
            if (list.length === 0) {
                 if (searchTerm) {
                     listContainer.innerHTML = `
                        <div class="empty-state-container" style="padding-top: 20px;">
                            <span class="material-icons-round" style="font-size: 48px; color: #ccc;">search_off</span>
                            <p style="color: #666; margin-top: 10px;">No results found</p>
                        </div>`;
                 } else {
                     // 注意：这里我们移除了按钮，因为现在按钮在 Sticky Footer 也有了，
                     // 但保留一个友好的空状态图也是好的。
                     const imageUrl = "https://cdn-icons-png.flaticon.com/512/609/609803.png"; 
                     listContainer.innerHTML = `
                        <div class="empty-state-container">
                            <div class="empty-state-img-wrapper">
                                <img src="${imageUrl}" alt="No Property">
                            </div>
                            <h3>No properties yet.</h3>
                            <p>Your property portfolio starts here.</p>
                        </div>
                     `;
                 }
                 return;
            }

            // 排序逻辑 (保持不变)
            list.sort((a, b) => {
                const aComplete = a.phase && a.phase > 2;
                const bComplete = b.phase && b.phase > 2;
                if (aComplete !== bComplete) return aComplete ? 1 : -1;
                if (aComplete && bComplete) {
                    if (a.status === 'Vacant' && b.status !== 'Vacant') return -1; 
                    if (a.status !== 'Vacant' && b.status === 'Vacant') return 1;
                }
                return 0; 
            });
            
            // 渲染列表
            list.forEach(p => {
                const isComplete = p.phase && p.phase > 2;
                const statusText = p.status || 'Vacant';
                
                // 状态颜色逻辑
                const statusClass = (p.status === 'Rented') ? 'status-rented' : 
                                    (isComplete ? 'status-vacant' : 'status-incomplete');
                
                // 获取数据
                const tenant = getTenantById(p.tenantId);
                const tenantName = tenant ? tenant.fullName.split(' ')[0] : 'None'; // 只取名字的第一部分，节省空间
                const propName = p.name || 'Unnamed Property';
                const propAddress = p.address || 'No Address';
                const propRent = p.monthlyRent ? `RM ${p.monthlyRent.toLocaleString()}` : '-';
                
                // 核心改动：使用新的 Compact HTML 结构
                
                // 1. 定义点击整个卡片的行为 (进入详情)
                const cardAction = `onclick="window.app.viewPropertyDetails('${p.id}');"`;
                
                // 2. 定义底部右侧的内容 (是显示租客名，还是显示 Link 按钮)
                let footerRightHTML = '';
                
                if (!isComplete) {
                    footerRightHTML = `<span style="color: #e65100; font-size: 11px;">Incomplete Setup</span>`;
                } else if (p.status === 'Rented') {
                    // 已出租状态 (保持不变)
                    footerRightHTML = `
                        <div class="compact-tenant-info">
                            <span class="material-icons-round" style="font-size: 14px; margin-right: 4px; color: #ccc;">person</span>
                            ${tenantName}
                        </div>
                    `;
                } else {
                    // Vacant 状态：【修改了这里】
                    // 1. Icon 改为 'person_add' (代表添加/关联人)
                    // 2. 文字改为 'Link Tenant'
                    footerRightHTML = `
                        <button class="compact-link-btn" onclick="window.app.openQuickLinkModal('${p.id}'); event.stopPropagation();">
                            <span class="material-icons-round" style="font-size: 16px;">person_add</span> Link Tenant
                        </button>
                    `;
                }

                listContainer.innerHTML += `
                    <div class="property-card-compact" ${cardAction} style="${!isComplete ? 'border-left-color: #FF9800;' : ''}">
                        
                        <div class="compact-header">
                            <div class="compact-title">${propName}</div>
                            <div class="compact-price">${propRent}</div>
                        </div>
                        
                        <div class="compact-address">${propAddress}</div>
                        
                        <div class="compact-footer">
                            <span class="compact-status ${statusClass}">${statusText}</span>
                            ${footerRightHTML}
                        </div>

                    </div>
                `;
            });
            
            // 增加底部留白，防止最后一个卡片被 Sticky Button 挡住
            listContainer.innerHTML += `<div style="height: 80px;"></div>`;
        }
        
        function renderProperties() {
            // Check if there is a search term and use the filter logic
            filterProperties(); 
        }

        function renderOwners() {
            const listContainer = document.getElementById('tabContentOwner');
            listContainer.innerHTML = '';

            if (owners.length === 0) {
				// 使用一个代表“用户/个人”的图标
				const imageUrl = "https://cdn-icons-png.flaticon.com/512/747/747376.png"; 
				
				listContainer.innerHTML = `
				<div class="empty-state-container">
					<div class="empty-state-img-wrapper" style="background-color: #f3e5f5;">
						<img src="${imageUrl}" alt="No Owners">
					</div>
					<h3>No owner profiles yet.</h3>
					<p>Create owner profiles to track details and link with properties.</p>
					<button class="empty-state-btn" onclick="window.app.handleNewEntry('owner')" style="background-color: #9B59B6;">
						Add New Owner
					</button>
				</div>
				`;
				return;
			}

            owners.forEach(o => {
                const associatedCount = properties.filter(p => p.ownerId === o.id).length;
                const statusText = associatedCount > 0 ? `${associatedCount} Properties` : 'No Properties';
                
                listContainer.innerHTML += `
                    <div class="property-card" onclick="window.app.viewOwnerDetails('${o.id}');">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <h4>${o.fullName || 'Owner Name N/A'}</h4>
                            <span class="status-tag-prop status-vacant" style="background-color: #eef4ff; color: #3A86FF;">${statusText}</span>
                        </div>
                        <div class="property-details-section">
                            <div class="detail-line address">
                                <p class="detail-item"><strong>Contact:</strong> ${o.phone || o.email || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function renderTenants() {
             const listContainer = document.getElementById('tabContentTenant');
            listContainer.innerHTML = '';
            
            if (tenants.length === 0) {
				// 使用一个代表“群组/家庭”的图标
				const imageUrl = "https://cdn-icons-png.flaticon.com/512/681/681494.png"; 
				
				listContainer.innerHTML = `
				<div class="empty-state-container">
					<div class="empty-state-img-wrapper" style="background-color: #e8f5e9;">
						<img src="${imageUrl}" alt="No Tenants">
					</div>
					<h3>No tenant profiles yet.</h3>
					<p>Add tenants to manage leases and track occupancy.</p>
					<button class="empty-state-btn" onclick="window.app.handleNewEntry('tenant')" style="background-color: #28a745;">
						Add New Tenant
					</button>
				</div>
				`;
				return;
			}

            tenants.forEach(t => {
                const associatedProperty = properties.find(p => p.tenantId === t.id);
                // 【修改】：将 >= 3 改为 >= 4
                const isComplete = t.phase && t.phase >= 4; 

                let statusText;
                let statusClass;
                let action;
                // 【修改】：显示的进度分母改为 4
                let phaseDisplay = t.phase < 4 ? `${t.phase}/4 complete` : 'Setup Complete';


                if (associatedProperty) {
                    statusText = `Renting: ${associatedProperty.name}`;
                    statusClass = 'status-rented';
                    action = `onclick="window.app.viewTenantDetails('${t.id}');"`;
                } else if (!isComplete) {
                    statusText = `Setup: ${phaseDisplay}`;
                    statusClass = 'status-incomplete';
                    action = `onclick="window.app.continueFormTask('${t.id}', false, 'tenant');"`; 
                } else {
                    statusText = 'Unassigned (Setup Complete)';
                    statusClass = 'status-vacant';
                    action = `onclick="window.app.viewTenantDetails('${t.id}');"`;
                }
                
                const displayName = t.preferredName 
                    ? `${t.fullName} (${t.preferredName})` 
                    : (t.fullName || 'Tenant Name N/A');

                listContainer.innerHTML += `
                    <div class="property-card ${statusClass === 'status-incomplete' ? 'incomplete-details' : ''}" ${action}>
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <h4>${displayName}</h4>
                            <span class="status-tag-prop ${statusClass}">${statusText}</span>
                        </div>
                        <div class="property-details-section">
                            <div class="detail-line address">
                                <p class="detail-item"><strong>Contact:</strong> ${t.phone || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // ===================================
        // Detail View Rendering Functions
        // ===================================
        
        /**
         * Renders the Property Detail Content with collapsible cards (Point 2)
         */
        function renderPropertyDetailsContent(prop, owner, tenant) {
            document.getElementById('detailPropertyName').textContent = prop.name || 'Property Profile';
            
            const content = document.getElementById('detailContent');
			
			let quickActionHtml = '';
    
			if (!tenant) {
				quickActionHtml = `
					<div class="primary-action-container">
						<button class="add-tenant-hero-btn" onclick="window.app.continueFormTask('${prop.id}', true, 'property')">
							<span class="material-icons-round">person_add</span>
							Link Tenant Now
						</button>
					</div>
				`;
			}

			// 2. 渲染内容 (注意：把 quickActionHtml 加在最前面)
			content.innerHTML = quickActionHtml + `
				<div class="detail-card rental-info">
					<h3 style="margin: 0 0 15px; font-size: 16px; font-weight: 700; color: #3A86FF;">RENTAL INFORMATION</h3>
					`;
			
            content.innerHTML = `
                <div class="detail-card rental-info">
                    <h3 style="margin: 0 0 15px; font-size: 16px; font-weight: 700; color: #3A86FF;">RENTAL INFORMATION</h3>
                    <div class="detail-group">
                        <div class="detail-item-aligned">
                            <p class="detail-label">Status</p>
                            <span class="status-tag-prop ${prop.status === 'Rented' ? 'status-rented' : 'status-vacant'} detail-value" style="margin-top: 2px;">
                                ${prop.status || 'Vacant'}
                            </span>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Rental Type</p>
                            <p class="detail-value">
                                ${RENTAL_TYPES.find(r => r.val === prop.rentalType)?.label || prop.rentalType || '-'}
                            </p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Monthly Rent (RM)</p>
                            <p class="detail-value">${prop.monthlyRent ? prop.monthlyRent.toLocaleString() : '-'}</p>
                        </div>
                    </div>
                </div>

                <div class="detail-card">
                    <h3 style="margin: 0 0 15px; font-size: 16px; font-weight: 700; color: #333;">BASIC INFORMATION</h3>
                    <div class="detail-group">
                         <div class="detail-item-full">
                            <p class="detail-label">Property Name</p>
                            <p class="detail-value">${prop.name || '-'}</p>
                        </div>
                        <div class="detail-item-full">
                            <p class="detail-label">Address</p>
                            <p class="detail-value">${prop.address || '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">City, State</p>
                            <p class="detail-value">${prop.city || '-'}, ${prop.state || '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Postal Code</p>
                            <p class="detail-value">${prop.postalCode || '-'}</p>
                        </div>
                        <div class="detail-item-full">
                            <p class="detail-label">Remark</p>
                            <p class="detail-value">${prop.remark || '-'}</p>
                        </div>
                    </div>
                </div>

                <div class="detail-card">
                    <h3 style="margin: 0 0 15px; font-size: 16px; font-weight: 700; color: #333;">SPECIFICATIONS</h3>
                    <div class="detail-group">
                        <div class="detail-item-aligned">
                            <p class="detail-label">House Type</p>
                            <p class="detail-value">${prop.houseType || '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Size (Sqft)</p>
                            <p class="detail-value">${prop.sizeSqft ? prop.sizeSqft.toLocaleString() : '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Rooms</p>
                            <p class="detail-value">${prop.rooms || '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Bathrooms</p>
                            <p class="detail-value">${prop.bathrooms || '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Carpark</p>
                            <p class="detail-value">${prop.carpark || '-'}</p>
                        </div>
                    </div>
                </div>

                <div class="detail-card owner-info collapse-card">
                    <div class="collapse-header" onclick="window.app.toggleCollapse('ownerDetailContentBody')">
                        <h3 style="font-size: 16px; font-weight: 700; color: #9B59B6;">
                            OWNER DETAILS ${owner ? `(${owner.fullName || 'N/A'})` : '(Not Assigned)'}
                        </h3>
                        <span class="material-icons-round collapse-icon" id="ownerDetailContentBodyIcon">expand_more</span>
                    </div>
                    <div id="ownerDetailContentBody" class="detail-group" style="display: none;">
                        ${owner ? `
                             <div class="detail-item-full" style="margin-bottom: 5px;">
                                <a href="#" onclick="window.app.viewOwnerDetails('${owner.id}'); return false;" style="font-size: 13px; color: #3A86FF; font-weight: 600;">
                                    <span class="material-icons-round" style="font-size: 18px; vertical-align: middle;">person</span> View Owner Profile
                                </a>
                            </div>
                            <div class="detail-item-aligned">
                                <p class="detail-label">Full Name</p>
                                <p class="detail-value">${owner.fullName || '-'}</p>
                            </div>
                            <div class="detail-item-aligned">
                                <p class="detail-label">Phone Number</p>
                                <p class="detail-value">${owner.phone || '-'}</p>
                            </div>
                            <div class="detail-item-full"> 
                                <p class="detail-label">Email Address</p>
                                <p class="detail-value">${owner.email || '-'}</p>
                            </div>
                            <div class="detail-item-aligned">
                                <p class="detail-label">Management Fee</p>
                                <p class="detail-value">${owner.managementFee ? owner.managementFee + '%' : '-'}</p>
                            </div>
                        ` : '<p class="detail-value" style="color: #999;">No owner is currently assigned.</p>'}
                    </div>
                </div>

                <div class="detail-card tenant-info collapse-card">
                     <div class="collapse-header" onclick="window.app.toggleCollapse('tenantDetailContentBody')">
                        <h3 style="font-size: 16px; font-weight: 700; color: #155724;">
                            TENANT DETAILS ${tenant ? `(${tenant.fullName || 'N/A'})` : '(Vacant)'}
                        </h3>
                        <span class="material-icons-round collapse-icon" id="tenantDetailContentBodyIcon">expand_more</span>
                    </div>
                    <div id="tenantDetailContentBody" class="detail-group" style="display: none;">
                        ${tenant ? `
                             <div class="detail-item-full" style="margin-bottom: 5px;">
                                <a href="#" onclick="window.app.viewTenantDetails('${tenant.id}'); return false;" style="font-size: 13px; color: #3A86FF; font-weight: 600;">
                                    <span class="material-icons-round" style="font-size: 18px; vertical-align: middle;">person</span> View Tenant Profile
                                </a>
                            </div>
                            <div class="detail-item-aligned">
                                <p class="detail-label">Full Name</p>
                                <p class="detail-value">${tenant.fullName || '-'}</p>
                            </div>
                            <div class="detail-item-aligned">
                                <p class="detail-label">Phone Number</p>
                                <p class="detail-value">${tenant.phone || '-'}</p>
                            </div>
                            <div class="detail-item-aligned">
                                <p class="detail-label">Tenancy Start</p>
                                <p class="detail-value">${tenant.leaseStart || '-'}</p>
                            </div>
                            <div class="detail-item-aligned">
                                <p class="detail-label">Tenancy End</p>
                                <p class="detail-value">${tenant.leaseEnd || '-'}</p>
                            </div>
                        ` : '<p class="detail-value" style="color: #999;">No tenant is currently assigned to this property.</p>'}
                    </div>
                </div>
            `;
        }

        function renderOwnerDetailView(owner) {
            document.getElementById('detailOwnerName').textContent = owner.fullName || 'Owner Profile';
            document.getElementById('ownerEditBtn').setAttribute('onclick', `window.app.continueFormTask('${owner.id}', true, 'owner'); return false;`); // Changed to continueFormTask (Point 4)
            
            const associatedProperties = properties.filter(p => p.ownerId === owner.id);
            const propList = associatedProperties.map(p => 
                `<p class="detail-value" style="font-size: 15px; margin-bottom: 5px;">
                    <a href="#" onclick="window.app.viewPropertyDetails('${p.id}'); return false;">
                        ${p.name} (${p.status})
                    </a>
                 </p>`
            ).join('');

            const content = document.getElementById('ownerDetailContent');
            content.innerHTML = `
                <div class="detail-card owner-info">
                    <h3 style="margin: 0 0 15px; font-size: 16px; font-weight: 700; color: #9B59B6;">OWNER DETAILS</h3>
                    <div id="ownerDetails" class="detail-group">
                        <div class="detail-item-aligned">
                            <p class="detail-label">Full Name</p>
                            <p class="detail-value">${owner.fullName || '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Phone Number</p>
                            <p class="detail-value">${owner.phone || '-'}</p>
                        </div>
                        <div class="detail-item-full"> 
                            <p class="detail-label">Email Address</p>
                            <p class="detail-value">${owner.email || '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Management Fee</p>
                            <p class="detail-value">${owner.managementFee ? owner.managementFee + '%' : '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Bank Account Details</p>
                            <p class="detail-value">${owner.bankDetails || '-'}</p>
                        </div>
                        <div class="detail-item-full">
                            <p class="detail-label">Mailing Address</p>
                            <p class="detail-value">${owner.address || '-'}</p>
                        </div>
                    </div>
                </div>

                <div class="detail-card">
                    <h3 style="margin: 0 0 15px; font-size: 16px; font-weight: 700; color: #333;">ASSOCIATED PROPERTIES (${associatedProperties.length})</h3>
                    <div class="detail-group">
                        ${associatedProperties.length > 0 ? propList : '<p class="detail-value" style="color: #999;">No properties currently linked.</p>'}
                    </div>
                </div>
            `;
        }
        
        function renderTenantDetailView(tenant) {
            document.getElementById('detailTenantName').textContent = tenant.fullName || 'Tenant Profile';
            const action = tenant.phase >= 3 ? `window.app.continueFormTask('${tenant.id}', true, 'tenant'); return false;` : `window.app.continueFormTask('${tenant.id}', false, 'tenant'); return false;`; // Changed to continueFormTask (Point 4)
            document.getElementById('tenantEditBtn').setAttribute('onclick', action);
            
            const associatedProperty = properties.find(p => p.tenantId === tenant.id);
            
            const content = document.getElementById('tenantDetailContent');
            content.innerHTML = `
                <div class="detail-card tenant-info">
                    <h3 style="margin: 0 0 15px; font-size: 16px; font-weight: 700; color: #155724;">TENANT DETAILS</h3>
                    <div class="detail-group">
                        <div class="detail-item-aligned">
                            <p class="detail-label">Full Name</p>
                            <p class="detail-value">${tenant.fullName || '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Preferred Name</p>
                            <p class="detail-value">${tenant.preferredName || '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Phone Number</p>
                            <p class="detail-value">${tenant.phone || '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Email Address</p>
                            <p class="detail-value">${tenant.email || '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">IC/Passport</p>
                            <p class="detail-value">${tenant.icPassport || '-'}</p>
                        </div>
                        
                        <div class="detail-item-full" style="margin-top: 5px;">
                            <p class="detail-label">Registered Address</p>
                            <p class="detail-value">${tenant.regAddress || '-'}</p>
                        </div>

                        <div class="detail-item-aligned">
                            <p class="detail-label">Tenancy Start</p>
                            <p class="detail-value">${tenant.leaseStart || '-'}</p>
                        </div>
                        <div class="detail-item-aligned">
                            <p class="detail-label">Tenancy End</p>
                            <p class="detail-value">${tenant.leaseEnd || '-'}</p>
                        </div>
                        <div class="detail-item-full">
                            <p class="detail-label">Tenancy Agreement</p>
                            <p class="detail-value">
                                ${tenant.agreementFile ? `
                                    <a href="#" onclick="window.app.viewDummyFile('${tenant.agreementFile}'); return false;" class="file-link">
                                        <span class="material-icons-round">description</span> View Signed Agreement
                                    </a>
                                ` : 'N/A (Agreement Missing)'}
                            </p>
                        </div>
                    </div>
                </div>

                <div class="detail-card">
                    <h3 style="margin: 0 0 15px; font-size: 16px; font-weight: 700; color: #333;">ASSOCIATED PROPERTY</h3>
                    <div class="detail-group">
                        ${associatedProperty ? `
                            <p class="detail-value" style="font-size: 15px;">
                                <a href="#" onclick="window.app.viewPropertyDetails('${associatedProperty.id}'); return false;">
                                    ${associatedProperty.name} (${associatedProperty.address})
                                </a>
                            </p>
                        ` : '<p class="detail-value" style="color: #999;">Not currently linked to a property.</p>'}
                    </div>
                </div>
            `;
        }

        // ===================================
        // Form Logic
        // ===================================

        function renderPropertyFields(prop, isEditMode) {
            const existingData = prop || {};
            const houseTypeOptions = HOUSE_TYPES.map(type => 
                `<option value="${type}" ${existingData.houseType === type ? 'selected' : ''}>${type}</option>`
            ).join('');
            
            const rentalTypeOptions = RENTAL_TYPES.map(opt => `<option value="${opt.val}" ${existingData.rentalType === opt.val ? 'selected' : ''}>${opt.label}</option>`).join('');

            const stateOptions = MALAYSIAN_STATES.map(state => 
                `<option value="${state}" ${existingData.state === state ? 'selected' : ''}>${state}</option>`
            ).join('');

            // Basic Info (Part of Point 2 from previous request)
            let basicHtml = `
                <div class="detail-card">
                    <h3 style="margin: 0 0 15px; font-size: 16px; font-weight: 700; color: #333;">BASIC INFORMATION</h3>
                    <div class="detail-group">
                        <div class="detail-item-full form-group">
                            <label for="p-name">Property Name <span style="color:red">*</span></label>
                            <input type="text" id="p-name" name="name" value="${existingData.name || ''}" required>
                        </div>
                        <div class="detail-item-full form-group">
                            <label for="p-address">Address <span style="color:red">*</span></label>
                            <input type="text" id="p-address" name="address" value="${existingData.address || ''}" required>
                        </div>
                        <div class="detail-item-aligned form-group">
                            <label for="p-postal">Postal Code <span style="color:red">*</span></label>
                            <input type="number" id="p-postal" name="postalCode" 
							   value="${existingData.postalCode || ''}" required
							   inputmode="numeric" 
							   oninput="window.app.validateNumber(this)">
                        </div>
                        <div class="detail-item-aligned form-group">
                            <label for="p-city">City <span style="color:red">*</span></label>
                            <input type="text" id="p-city" name="city" value="${existingData.city || ''}" required>
                        </div>
                        <div class="detail-item-aligned form-group">
                            <label for="p-state">State <span style="color:red">*</span></label>
                            <select id="p-state" name="state" required onchange="window.app.checkSelectPlaceholder(this.id)">
                                <option value="" disabled ${!existingData.state ? 'selected' : ''}>Select State</option>
                                ${stateOptions}
                            </select>
                        </div>
                        <div class="detail-item-aligned form-group">
                            <label for="p-country">Country <span style="color:red">*</span></label>
                            <input type="text" id="p-country" name="country" value="${existingData.country || 'Malaysia'}" required>
                        </div>
                        <div class="detail-item-full form-group">
                            <label for="p-remark">Remark</label>
                            <input type="text" id="p-remark" name="remark" value="${existingData.remark || ''}">
                        </div>
                    </div>
                </div>
            `;
            
            // Rental Info
            let rentalHtml = `
                <div class="detail-card rental-info">
                     <h3 style="margin: 0 0 15px; font-size: 16px; font-weight: 700; color: #3A86FF;">RENTAL INFORMATION</h3>
                    <div class="detail-group">
                        <div class="detail-item-full form-group" style="margin-bottom: 10px;">
                            <label for="p-rentalType">Rental Type <span style="color:red">*</span></label>
                            <select id="p-rentalType" name="rentalType" required 
                                onchange="window.app.updateRentLabel(this.value); window.app.checkSelectPlaceholder(this.id);">
                                <option value="" disabled ${!existingData.rentalType ? 'selected' : ''}>Select Rental Type</option>
                                ${rentalTypeOptions}
                            </select>
                        </div>
                        
                        <div class="rental-detail-item form-group">
                            <label for="p-type">House Type <span style="color:red">*</span></label>
                            <select id="p-type" name="houseType" required onchange="window.app.checkSelectPlaceholder(this.id)">
                                <option value="" disabled ${!existingData.houseType ? 'selected' : ''}>Select Type</option>
                                ${houseTypeOptions}
                            </select>
                        </div>
                        <div class="rental-detail-item form-group">
                            <label id="rentLabel" for="p-rent" class="detail-label">Monthly Rental (RM) <span style="color:red">*</span></label>
                            <input type="number" id="p-rent" name="monthlyRent" 
							   value="${existingData.monthlyRent || ''}" required
							   inputmode="numeric" 
							   oninput="window.app.validateNumber(this)">
                        </div>
                        

                    </div>
                </div>
            `;

            // Specification
            let specHtml = `
                <div class="detail-card">
                     <h3 style="margin: 0 0 15px; font-size: 16px; font-weight: 700; color: #333;">SPECIFICATIONS</h3>
                    <div class="detail-group">
                        <div class="detail-item-aligned form-group">
                            <label for="p-rooms">No. of Rooms <span style="color:red">*</span></label>
                            <input type="number" id="p-rooms" name="rooms" 
							   value="${existingData.rooms || ''}" required
							   inputmode="numeric" 
							   oninput="window.app.validateNumber(this)">
                        </div>
                        <div class="detail-item-aligned form-group">
                            <label for="p-bathrooms">No. of Bathrooms <span style="color:red">*</span></label>
                            <input type="number" id="p-bathrooms" name="bathrooms" 
							   value="${existingData.bathrooms || ''}" required
							   inputmode="numeric" 
							   oninput="window.app.validateNumber(this)">
                        </div>

                        <div class="detail-item-aligned form-group">
                            <label for="p-size">Size (Sqft)</label>
                            <input type="number" id="p-size" name="sizeSqft" 
							   value="${existingData.sizeSqft || ''}"
							   inputmode="numeric" 
							   oninput="window.app.validateNumber(this)">
                        </div>
                        <div class="detail-item-aligned form-group">
                            <label for="p-carpark">Carpark</label>
                            <input type="number" id="p-carpark" name="carpark" 
							   value="${existingData.carpark || ''}"
							   inputmode="numeric" 
							   oninput="window.app.validateNumber(this)">
                        </div>
                    </div>
                </div>
            `;
            
            // Order required: Rental, Basic, Specification (Point 2)
            return rentalHtml + basicHtml + specHtml;
        }


        /**
         * Dynamic update Monthly Rent label based on rentalType selection.
         */
        function updateRentLabel(rentalType) {
            const labelElement = document.getElementById('rentLabel');
            if (!labelElement) return;

            if (rentalType === 'whole_unit') {
                labelElement.innerHTML = 'Monthly Rental (Whole Unit) <span style="color:red">*</span>';
            } else if (rentalType === 'room_by_room') {
                labelElement.innerHTML = 'Monthly Rental (Estimated Total) <span style="color:red">*</span>';
            } else {
                labelElement.innerHTML = 'Monthly Rental (RM) <span style="color:red">*</span>';
            }
        }

        /**
         * Helper to visually adjust select color based on value.
         */
        function checkSelectPlaceholder(id) {
            const select = document.getElementById(id);
            if (select) {
                // Use a proper class/check to ensure selected options are dark
                if (select.value === "" || select.value === null || select.selectedIndex === 0) {
                    select.style.color = '#999'; 
                } else {
                    select.style.color = '#333'; 
                }
            }
        }
        
        function selectTenant(tenantId) {
             const select = document.getElementById('p-tenantId');
             if (select) {
                 select.value = tenantId;
             }
             // checkSelectPlaceholder will handle the color change automatically
        }


        function handleFormSubmit(e) {
            e.preventDefault();
            
            const currentId = document.getElementById('currentId').value;
            const currentPhase = document.getElementById('currentFormPhase').value;
            const currentFormType = document.getElementById('currentFormType').value;
            const formEl = document.getElementById('dataEntryForm');
            // 获取我们在 renderForm 中绑定的简单编辑状态
            const isSimpleTenantEdit = formEl && formEl.dataset && formEl.dataset.simpleEdit === 'true';
            
            const formData = new FormData(e.target);
            
            const updateData = {};
            for (let [key, value] of formData.entries()) {
                if (key === 'phase' || key === 'type' || key === 'id' || key === 'ownerId' || key === 'tenantId') continue; 
                
                if (['monthlyRent', 'sizeSqft', 'rooms', 'bathrooms', 'carpark', 'managementFee'].includes(key)) {
                    updateData[key] = parseFloat(value) || 0; 
                } else {
                    updateData[key] = value;
                }
            }
            
            // --- 1. Owner Logic ---
            if (currentFormType === 'owner') {
                createOwnerHandler(formData); 
                return;
            }

            // --- 2. Tenant Logic ---
            if (currentFormType === 'tenant') {
                 const tenant = getTenantById(currentId);
                 const task = getTaskByTenantId(currentId);
                 
                 // 情况 A: 简单编辑 (Edit Profile) -> 保存并返回列表
                 if (isSimpleTenantEdit) {
                    saveTenantData(currentId, { ...(tenant || {}), ...updateData, phase: tenant && tenant.phase ? tenant.phase : 4 });
                    saveData();
                    alertMessage('Tenant updated.', 'success');
                    switchView('property');
                    switchPropertyTab('tenant');
                    return;
                 }

                 // 情况 B: 创建流程 (Multi-step Setup)
                 const nextPhase = parseInt(currentPhase) + 1;
                 
                 if (currentPhase === '0') {
                    // Step 1 -> 2
                    saveTenantData(currentId, {...updateData, phase: nextPhase});
                    // 创建任务
                    updateTaskData(`task-${currentId}`, { 
                        id: `task-${currentId}`, 
                        type: 'tenant_setup', 
                        tenantId: currentId, 
                        phase: nextPhase, 
                        description: `Setup Tenancy for ${updateData.fullName || 'New Tenant'}`, 
                        details: 'Step 2/3: Send and await signed tenancy agreement.', 
                        status: 'in_progress', 
                        userId: currentUserId 
                    });
                    renderForm(currentId, nextPhase, 'tenant');

                } else if (currentPhase === '1') {
                    // Step 2 -> 3
                    saveTenantData(currentId, { ...tenant, phase: nextPhase }); 
                    updateTaskData(task.id, { phase: nextPhase, details: 'Step 3/4: Upload the signed tenancy agreement.' });
                    renderForm(currentId, nextPhase, 'tenant');

                } else if (currentPhase === '2') {
                    // Step 3 -> 4 (Upload -> Assign)
                    const agreementFile = document.getElementById('t-agreementFile').files[0];
                    const fileName = agreementFile ? agreementFile.name : (tenant.agreementFile || '');
                    
                    if (!fileName) { alertMessage('Please upload the signed Tenancy Agreement.', 'error'); return; }
                    
                    saveTenantData(currentId, { ...tenant, ...updateData, agreementFile: fileName, phase: 3 });
                    updateTaskData(task.id, { phase: 3, details: 'Step 4/4: Assign tenant to a property.' });
                    renderForm(currentId, 3, 'tenant');
                    
                } else if (currentPhase === '3') {
                    // --- PHASE 3: Assign Property & Complete ---
                    
                    // 1. 定义最终完成的逻辑 (封装起来)
                    const finalizeSetup = () => {
                        const assignedPropId = document.getElementById('t-assignProperty').value;
                        
                        // 标记租客为 Phase 4 (Setup Complete)
                        saveTenantData(currentId, { ...tenant, phase: 4 });
                        
                        if (assignedPropId) {
                            const prop = getPropertyById(assignedPropId);
                            if (prop) {
                                updatePropertyData(assignedPropId, { 
                                    ...prop, 
                                    tenantId: currentId, 
                                    status: 'Rented',
                                    phase: 3 
                                });
                                // 创建收租任务
                                if (window.app.createFirstRentTask) {
                                    window.app.createFirstRentTask(assignedPropId, prop.name);
                                } else {
                                    createFirstRentTask(assignedPropId, prop.name);
                                }
                            }
                        }

                        if (task) { tasks = tasks.filter(t => t.id !== task.id); }
                        saveData();
                        alertMessage(`Tenant ${tenant.fullName || 'Tenant'} setup complete!`, 'success');
                        switchView('property'); 
                        switchPropertyTab('tenant');
                    };
					
					showConfirmation(
                        'Confirm Tenant Details', 
                        'Confirm the tenants’ details are correct. Tenancy Agreement will be generated after this.', 
                        (confirmed) => {
                            // 只有点击了 Confirmed 才执行保存
                            if (confirmed) finalizeSetup();
                        },
                        'Confirmed', 
                        'btn-confirm btn-primary-modal' 
                    );
					
				}
                return;
            }

            // --- 3. Property Logic ---
            const prop = getPropertyById(currentId);
            const task = getTaskByPropId(currentId);
            
            if (currentPhase === '0') {
                const selectedOwnerId = document.getElementById('selectedOwnerId').value;
                if (!selectedOwnerId) { alertMessage('Please select or create an Owner Profile first.', 'error'); return; }
                
                updatePropertyData(currentId, {...updateData, phase: 1, ownerId: selectedOwnerId});
                
                // 创建任务 (Task Step 2/2)
                updateTaskData(`task-${currentId}`, { 
                     id: `task-${currentId}`, 
                     type: 'property', 
                     propId: currentId, 
                     phase: 1, 
                     description: 'Setup New Property', 
                     details: 'Step 2/2: Basic Property Details.', 
                     status: 'in_progress', 
                     userId: currentUserId 
                 });

                renderForm(currentId, 1, 'property'); 
            } 
            else if (currentPhase === '1') {
                showLoading();
                const propName = (updateData.name && updateData.name.trim() !== '') ? updateData.name : (prop && prop.name) ? prop.name : 'New Property';
                // 默认状态为 Vacant，且 Phase 3 代表完成
                updatePropertyData(currentId, { ...(prop || {}), ...updateData, phase: 3, status: 'Vacant' });
                
                if (task) { tasks = tasks.filter(t => t.id !== task.id); }
                saveData();
                alertMessage(`Property "${propName}" saved successfully!`, 'success');
                document.getElementById('dataEntryForm').reset();
                switchView('dashboard');
                hideLoading();
            }
            else if (currentPhase === '3') {
                // Phase 3: Edit Mode
                showLoading();
                const oldTenantId = prop.tenantId;
                const newTenantId = document.getElementById('p-tenantId')?.value || '';
                
                // 自动判断状态：有租客=Rented，无租客=Vacant
                const autoStatus = newTenantId ? 'Rented' : 'Vacant';

                updatePropertyData(currentId, {
                    ...updateData, 
                    phase: 3, 
                    status: autoStatus, 
                    tenantId: newTenantId
                });
                
                // 如果分配了新租客，创建收租任务
                if (newTenantId && newTenantId !== oldTenantId) {
                     alertMessage('Tenant successfully assigned. Creating monthly rent reminder task.', 'info');
                     if (window.app.createFirstRentTask) {
                        window.app.createFirstRentTask(currentId, updateData.name || prop.name);
                     } else {
                        createFirstRentTask(currentId, updateData.name || prop.name);
                     }
                }
                
                saveData(); 
                alertMessage(`Property "${updateData.name || prop.name}" updated successfully.`, 'success');
                viewPropertyDetails(currentId);
                hideLoading(); 
            }
        }

		function selectOwnerAndProceed(ownerId) {
            const currentPropId = document.getElementById('currentId').value;
            const owner = getOwnerById(ownerId);
            
            if (!owner || !currentPropId) return;

            // 1. 保存关联
            updatePropertyData(currentPropId, { 
                phase: 1, // 自动进入 Phase 1
                ownerId: ownerId 
            });

            // 2. 更新/创建任务状态
            updateTaskData(`task-${currentPropId}`, { 
                id: `task-${currentPropId}`, 
                type: 'property', 
                propId: currentPropId, 
                phase: 1, 
                description: 'Setup New Property', 
                details: 'Step 2/2: Basic Property Details.', 
                status: 'in_progress', 
                userId: currentUserId 
            });

            // 3. 视觉反馈 + 跳转
            // window.app.alertMessage(`Selected ${owner.fullName}`, 'success'); // 可选：提示一下
            renderForm(currentPropId, 1, 'property');
        }

        function renderForm(id, phase, type) { 
            const formTitle = document.getElementById('formTitle');
            const formFields = document.getElementById('formFields');
            const form = document.getElementById('dataEntryForm');
			
			form.onsubmit = window.app.handleFormSubmit;
            
            document.getElementById('currentFormType').value = type;
            document.getElementById('currentFormPhase').value = phase;
            document.getElementById('currentId').value = id;
            document.getElementById('selectedOwnerId').value = id.startsWith('prop-') ? document.getElementById('selectedOwnerId').value : ''; 

            if (type === 'owner') { 
                // Owner Form Logic (Point 4)
                const ownerToEdit = getOwnerById(id);
                document.getElementById('formTitle').textContent = ownerToEdit ? 'Edit Owner Profile' : 'Create New Owner Profile';
                document.getElementById('formBackBtn').innerHTML = `<span class="material-icons-round">arrow_back_ios</span> Cancel`;
                
                let existingData = ownerToEdit || {};
                 let fieldsHTML = `
                    <div class="detail-card">
                        <div class="detail-group">
                            <div class="detail-item-full form-group">
                                <label for="p-fullName">Full Name (as per NRIC/Passport) <span style="color:red">*</span></label>
                                <input type="text" id="p-fullName" name="fullName" value="${existingData.fullName || ''}" required>
                            </div>
                            <div class="detail-item-aligned form-group">
                                <label for="p-phone">Phone Number <span style="color:red">*</span></label>
                                <input type="tel" id="p-phone" name="phone" value="${existingData.phone || ''}" required>
                            </div>
                            <div class="detail-item-aligned form-group">
                                <label for="p-email">Email Address </label>
                                <input type="email" id="p-email" name="email" value="${existingData.email || ''}">
                            </div>
                            <div class="detail-item-full form-group">
                                <label for="p-address">Mailing Address</label>
                                <input type="text" id="p-address" name="address" value="${existingData.address || ''}">
                            </div>
                            <div class="detail-item-full form-group">
                                <label for="p-bankDetails">Bank Account Details </label>
                                <input type="text" id="p-bankDetails" name="bankDetails" value="${existingData.bankDetails || ''}">
                            </div>
                            <div class="detail-item-full form-group">
                                <label for="p-managementFee">Management Fee (Fixed Amount)</label>
                                <input type="number" id="p-managementFee" name="managementFee" value="${existingData.managementFee || ''}" placeholder="e.g., 300">
                            </div>
                        </div>
                    </div>
                `;
                fieldsHTML += `
                    <div class="form-footer">
                        <button type="submit" class="submit-btn" id="formSubmitButton" form="dataEntryForm">
                            ${ownerToEdit ? 'Save Changes' : 'Create Owner'}
                        </button>
                    </div>
                `;
                document.getElementById('formFields').innerHTML = fieldsHTML;
                switchView('form');
                return;
            }
             if (type === 'tenant') { 
                // Tenant Form Logic (Point 4)
                 const tenant = getTenantById(id);
                 let existingData = tenant || {};
                 let formTitleText = '';
                 let submitButtonText = '';
                 let fieldsHTML = '';
                 const simpleEdit = window.app.simpleTenantEdit === true;
                 
				 document.getElementById('dataEntryForm').dataset.simpleEdit = simpleEdit;
				 
                 if (phase === 0) {
                    formTitleText = simpleEdit ? 'Edit Tenant' : '1/3: Basic Tenant Information';
                    submitButtonText = simpleEdit ? 'Save Changes' : 'Save & Next';
                    fieldsHTML = `
                        <div class="detail-card">
                            <div class="detail-group">
                                <div class="detail-item-full form-group">
                                    <label for="t-fullName">Full Name (as per NRIC/Passport) <span style="color:red">*</span></label>
                                    <input type="text" id="t-fullName" name="fullName" value="${existingData.fullName || ''}" required>
                                </div>
                                
                                <div class="detail-item-full form-group">
                                    <label for="t-preferredName">Preferred Name</label>
                                    <input type="text" id="t-preferredName" name="preferredName" value="${existingData.preferredName || ''}" >
                                </div>

                                <div class="detail-item-aligned form-group">
                                    <label for="t-phone">Phone Number <span style="color:red">*</span></label>
                                    <input type="tel" id="t-phone" name="phone" value="${existingData.phone || ''}" required>
                                </div>
                                <div class="detail-item-aligned form-group">
                                    <label for="t-email">Email Address <span style="color:red">*</span></label>
                                    <input type="email" id="t-email" name="email" value="${existingData.email || ''}" required>
                                </div>
                                <div class="detail-item-full form-group">
                                    <label for="t-icPassport">IC/Passport Number <span style="color:red">*</span></label>
                                    <input type="text" id="t-icPassport" name="icPassport" value="${existingData.icPassport || ''}" required>
                                </div>

                                <div class="detail-item-full form-group">
                                    <label for="t-regAddress">Registered Address </label>
                                    <input type="text" id="t-regAddress" name="regAddress" value="${existingData.regAddress || ''}">
                                </div>

                                <div class="detail-item-aligned form-group">
									<label for="t-leaseStart">Tenancy Start Date</label>
									<input type="date" id="t-leaseStart" name="leaseStart" 
										   value="${existingData.leaseStart || ''}"
										   onchange="window.app.calculateEndDate()">
								</div>

								<div class="detail-item-aligned form-group">
									<label for="t-leaseTerm">Tenancy Term (Months)</label>
									<input type="number" id="t-leaseTerm" name="leaseTerm" 
										   value="${existingData.leaseTerm || ''}" 
										   inputmode="numeric"
										   onkeydown="if(['e', 'E', '+', '-'].includes(event.key)) event.preventDefault()"
										   oninput="window.app.validateNumber(this); window.app.calculateEndDate()">
								</div>

								<div class="detail-item-full form-group">
									<label for="t-leaseEnd">Tenancy End Date </label>
									<input type="date" id="t-leaseEnd" name="leaseEnd" 
										   value="${existingData.leaseEnd || ''}">
								</div>
                            </div>
                        </div>
                    `;
                 } else if (phase === 1) {
                    formTitleText = '2/3: Send Tenancy Agreement';
                    submitButtonText = 'Next: Upload Agreement';
                    fieldsHTML = `
                        <div class="detail-card">
                            <p style="color: #666; margin-top: 0;">Tenancy Agreement needs to be sent to the tenant for signing.</p>
                            <div class="detail-item-full form-group">
                                <label>Tenant: ${existingData.fullName || 'N/A'}</label>
                                <p style="font-size: 14px; color: #3A86FF;">
                                    Contact: ${existingData.phone || 'N/A'}
                                </p>
                            </div>
                            
                            <a href="#" class="submit-btn" style="background-color: #25d366; margin-bottom: 10px; display: flex; justify-content: center; align-items: center; gap: 8px; text-decoration: none; box-sizing: border-box;" onclick="window.app.alertMessage('Simulating WhatsApp message sent!', 'success'); return false;">
                                <span class="material-icons-round" style="font-size: 20px;">chat</span> 
                                Send via WhatsApp
                            </a>
                            
                            <a href="#" class="submit-btn" style="background-color: #f7931e; display: flex; justify-content: center; align-items: center; gap: 8px; text-decoration: none; box-sizing: border-box;" onclick="window.app.alertMessage('Simulating Email sent!', 'success'); return false;">
                                <span class="material-icons-round" style="font-size: 20px;">email</span> 
                                Send via Email
                            </a>
                        </div>
                    `;
                 } else if (phase === 2) {
                    formTitleText = '3/4: Upload Signed Agreement';
                    // 【修改】：按钮文字改为 Next
                    submitButtonText = 'Next: Assign Property';

                    fieldsHTML = `
                        <div class="detail-card">
                            <p style="color: #666; margin-top: 0;">Upload the signed Tenancy Agreement received from the tenant.</p>
                            
                            <div class="detail-item-full form-group">
                                <label for="t-agreementFile">Tenancy Agreement File <span style="color:red">*</span></label>
                                <input type="file" id="t-agreementFile" name="agreementFile" ${existingData.agreementFile ? '' : 'required'}>
                            </div>
                            
                            ${existingData.agreementFile ? `
                                <p style="font-size: 14px; color: #555; margin-top: 15px;">
                                    Current File: 
                                    <a href="#" onclick="window.app.viewDummyFile('${existingData.agreementFile}'); return false;" class="file-link">
                                        <span class="material-icons-round">insert_drive_file</span> ${existingData.agreementFile}
                                    </a>
                                </p>
                            ` : ''}
                        </div>
                    `;
                 } else if (phase === 3) {
                    // --- PHASE 3: 界面渲染 ---
                    formTitleText = '4/4: Assign Property';
                    submitButtonText = 'Complete Tenant Setup';
                    
                    // 过滤出所有空置的房产 (没有 tenantId) 或者是当前已经分配给该租客的房产
                    const availableProperties = properties.filter(p => !p.tenantId || p.tenantId === id);
                    
                    // 生成选项 HTML
                    const propOptions = availableProperties.map(p => 
                        `<option value="${p.id}" ${p.tenantId === id ? 'selected' : ''}>${p.name} (${p.status || 'Vacant'})</option>`
                    ).join('');

                    fieldsHTML = `
                        <div class="detail-card">
                            <p style="color: #666; margin-top: 0;">Select a property to assign this tenant to immediately.</p>
                            
                            <div class="detail-item-full form-group">
                                <label for="t-assignProperty">Assign to Property</label>
                                <select id="t-assignProperty" name="assignProperty" class="placeholder-text" onchange="window.app.checkSelectPlaceholder(this.id)">
                                    <option value="" ${availableProperties.length === 0 ? 'selected' : ''}>-- Select a Property (Optional) --</option>
                                    ${propOptions}
                                </select>
                            </div>
                            
                            ${availableProperties.length === 0 ? `
                                <div class="detail-item-full form-group" style="margin-top: 10px;">
                                    <p style="font-size: 13px; color: #e65100; background: #fff3cd; padding: 8px; border-radius: 6px;">
                                        Note: No vacant properties available. You can complete setup now and assign later from the Property details.
                                    </p>
                                </div>
                            ` : ''}
                        </div>
                    `;
                 }
                document.getElementById('formTitle').textContent = formTitleText;
				document.getElementById('formFields').innerHTML = fieldsHTML + `
					<div class="form-footer">
						<button type="submit" class="submit-btn" id="formSubmitButton" form="dataEntryForm">
							${submitButtonText}
						</button>
					</div>
				`;
				switchView('form'); // <-- 确保这一行存在且能执行
				return;
            }

            const prop = getPropertyById(id);
            const existingData = prop || {};
            let currentOwnerId = existingData.ownerId;
            let submitButtonText = '';
            let fieldsHTML = '';

            // Adjust back button text based on mode
            document.getElementById('formBackBtn').innerHTML = `<span class="material-icons-round">arrow_back_ios</span> ${phase === 3 ? 'Details' : 'Back'}`;
            
            form.onsubmit = window.app.handleFormSubmit;

            // --- PHASE 0: OWNER SELECTION/CREATION ---
            if (phase === 0) {
                formTitle.textContent = 'Select Owner';
                
                // 1. 定义空状态 HTML (当没有任何 Owner 数据时)
                const emptyStateHTML = `
                    <div class="empty-state-container" style="padding-top: 40px;">
                        <div class="empty-state-img-wrapper" style="background-color: #f3e5f5; margin-bottom: 20px;">
                            <img src="https://cdn-icons-png.flaticon.com/512/747/747376.png" alt="No Owners" style="width: 60%;">
                        </div>
                        <h3 style="color: #333;">Who owns this property?</h3>
                        <p style="color: #666; max-width: 280px;">Create an owner profile to start tracking rental income and expenses.</p>
                        
                        <div style="margin-top: 30px; width: 100%;">
                            <button class="create-owner-btn" onclick="window.app.handleNewEntry('owner'); document.getElementById('selectedOwnerId').value = '${id}'; return false;">
                                <span class="material-icons-round">person_add</span> Create First Owner
                            </button>
                        </div>
                    </div>
                `;

                // 2. 定义列表状态 HTML (当有 Owner 数据时)
                const listStateHTML = `
                    <div class="detail-card" style="border: none; shadow: none; padding: 0; background: transparent;">
                        <div style="position: relative; margin-bottom: 15px;">
                            <span class="material-icons-round" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #999; font-size: 20px;">search</span>
                            <input type="text" id="ownerSearch" placeholder="Search owner name..." 
                                   oninput="window.app.filterOwners(this.value)"
                                   style="width: 100%; padding: 12px 12px 12px 40px; border: 1px solid #ddd; border-radius: 12px; font-size: 15px; outline: none; background: #fff;">
                        </div>

                        <p style="font-size: 13px; color: #666; margin-bottom: 10px; padding-left: 5px;">Existing Owners</p>

                        <div id="ownerListContainer" style="padding-bottom: 80px;"> 
                            </div>
                    </div>

                    <div class="sticky-footer-container">
                        <div class="sticky-footer-content">
                            <button class="create-owner-btn" onclick="window.app.handleNewEntry('owner'); document.getElementById('selectedOwnerId').value = '${id}'; return false;">
                                <span class="material-icons-round">add</span> Create New Owner
                            </button>
                        </div>
                    </div>
                `;

                // 3. 根据数据决定显示哪种状态
                if (owners.length === 0) {
                    fieldsHTML = emptyStateHTML;
                } else {
                    fieldsHTML = listStateHTML;
                    // 这里很重要：为了让初始列表显示出来，我们需要在 HTML 插入后调用一次 filter
                    setTimeout(() => { window.app.filterOwners(''); }, 0);
                }

                // 4. 重要：清空 Submit 按钮
                // 因为 Phase 0 现在是“点击即跳转”，不需要底部的 Next 按钮，
                // 我们在后面统一注入 footer 之前，可以通过一个特殊的 flag 告诉后面不要加按钮，或者直接在这里 return
                
                document.getElementById('formTitle').textContent = 'Select Owner';
                document.getElementById('formFields').innerHTML = fieldsHTML;
                
                // 特殊处理：Phase 0 不需要通用的 form-footer，因为有专门的逻辑
                switchView('form');
                
                // 如果是列表状态，手动触发一次渲染
                if (owners.length > 0) {
                     window.app.filterOwners('');
                }
                return; // 直接返回，不执行后面通用的 submit button 注入
            }
            // --- PHASE 1: BASIC PROPERTY DETAILS ---
            else if (phase === 1) {
                formTitle.textContent = '2/2: Basic Property Details'; 
                // Requirement: Finalize on this step
                submitButtonText = 'Save Property';
                
                fieldsHTML = renderPropertyFields(prop, false);
                
                window.app.checkSelectPlaceholder('p-state');
                window.app.checkSelectPlaceholder('p-rentalType');
                window.app.checkSelectPlaceholder('p-type');
            } 
            // --- PHASE 2 is no longer used for creation flow ---
            else if (phase === 2) {
                formTitle.textContent = 'Specifications & Rental (legacy)';
                submitButtonText = 'Save Property';
                fieldsHTML = renderPropertyFields(prop, true);
                window.app.checkSelectPlaceholder('p-rentalType');
                window.app.checkSelectPlaceholder('p-type');
                window.app.checkSelectPlaceholder('p-status');
                if (existingData.rentalType) { updateRentLabel(existingData.rentalType); }
            }
            // --- PHASE 3: FULL EDIT MODE (Point 1) ---
            else if (phase === 3) {
                formTitle.textContent = `Editing: ${prop.name || 'Property'}`;
                submitButtonText = 'Save Changes';
                document.getElementById('formBackBtn').innerHTML = `<span class="material-icons-round">arrow_back_ios</span> Details`;
                
                // Get tenants not associated with any *other* property
                const assignedTenantIds = properties.filter(p => p.id !== id && p.tenantId).map(p => p.tenantId);
                const vacantTenants = tenants.filter(t => t.phase >= 3 && !assignedTenantIds.includes(t.id)); 
                const currentTenant = existingData.tenantId ? getTenantById(existingData.tenantId) : null;
                
                let tenantOptions = '';
                if(currentTenant) {
                    tenantOptions += `<option value="${currentTenant.id}" selected>${currentTenant.fullName || 'Tenant N/A'} (Current)</option>`;
                }
                tenantOptions += vacantTenants.map(t => 
                    `<option value="${t.id}" ${existingData.tenantId === t.id && !currentTenant ? 'selected' : ''}>${t.fullName || 'Tenant N/A'} (${t.phone || 'Contact N/A'})</option>`
                ).join('');

                // Render Basic, Rental, Specification
                fieldsHTML = renderPropertyFields(prop, true);
                
                // Manually inject the corrected Tenant Assignment Card
                fieldsHTML += `
                    <div class="detail-card tenant-info">
                        <h3 style="margin: 0 0 15px; font-size: 16px; font-weight: 700; color: #155724;">
                            TENANT ASSIGNMENT
                        </h3>
                        <div class="detail-group">
                            <div class="detail-item-full form-group">
                                <label for="p-tenantId" class="detail-label">Current Tenant</label>
                                <select id="p-tenantId" name="tenantId" onchange="window.app.selectTenant(this.value); window.app.checkSelectPlaceholder(this.id);" class="placeholder-text">
                                    <option value="" ${!existingData.tenantId ? 'selected' : ''}>-- Select Current Tenant (Vacant) --</option>
                                    ${tenantOptions}
                                </select>
                            </div>
                            <div class="detail-item-full form-group" style="margin-top: 10px;">

                            </div>
                            <div class="detail-item-full form-group" style="margin-top: 10px;">
                                <p style="font-size: 12px; color: #555;">Note: Only 'Setup Complete' tenants who are not currently assigned to another property are shown above.</p>
                            </div>
                        </div>
                    </div>
                `;
                
                // Manually apply select color checks after fields are added
                window.app.checkSelectPlaceholder('p-state');
                window.app.checkSelectPlaceholder('p-rentalType');
                window.app.checkSelectPlaceholder('p-type');
                window.app.checkSelectPlaceholder('p-status');
                window.app.checkSelectPlaceholder('p-tenantId');

                if (existingData.rentalType) {
                    updateRentLabel(existingData.rentalType);
                }
            } else {
                formFields.innerHTML = '<p style="color: red;">Form phase error. Please restart the process.</p>';
                return; 
            }
            
            // Inject submit button after fields for all phases
            fieldsHTML += `
				<div class="form-footer">
					<button type="submit" class="submit-btn" id="formSubmitButton" form="dataEntryForm" 
						${phase === 0 && !currentOwnerId && !document.getElementById('selectedOwnerId').value ? 'disabled' : ''}>
						${submitButtonText}
					</button>
				</div>
			`;
            
            formFields.innerHTML = fieldsHTML;
			
			switchView('form'); 
            // ensure we clear any simple edit flag for non-tenant forms
            if (type !== 'tenant') {
                document.getElementById('dataEntryForm').dataset.simpleEdit = 'false';
            }

            // CRITICAL: Handle Phase 0 owner selection styling/state
            if (phase === 0) {
                if (currentOwnerId) {
                    window.app.selectOwner(currentOwnerId);
                }
                const selectedOwnerIdField = document.getElementById('selectedOwnerId');
                if (selectedOwnerIdField.value.startsWith('owner-')) {
                    window.app.selectOwner(selectedOwnerIdField.value);
                }
            }
        }
        
        function createOwnerHandler(formData) {
			const ownerId = document.getElementById('currentId').value;
			const data = {};
			for (let [key, value] of formData.entries()) {
				if (!['phase', 'type', 'id', 'ownerId', 'tenantId'].includes(key)) {
					data[key] = value;
				}
			}

			saveOwnerData(ownerId, data);
			alertMessage(`Owner profile created successfully.`, 'success');

			// Check if we came from the Property Phase 0 flow
			const selectedOwnerIdField = document.getElementById('selectedOwnerId');
			if (selectedOwnerIdField.value && selectedOwnerIdField.value.startsWith('prop-')) {
				const propId = selectedOwnerIdField.value;
				selectedOwnerIdField.value = ownerId; // Set the newly created owner as selected
				renderForm(propId, 0, 'property');
				window.app.selectOwner(ownerId);
			} else {
				 // Stand-alone owner creation, go back to owner list.
				// ⬇️ 关键修改 START
				switchView('property'); 
				switchPropertyTab('owner');
				// ⬆️ 关键修改 END
			}
		}

		function navigateAndAdd(type) {
			// 1. 切换到 Property 视图
			switchView('property');
			
			// 2. 切换到正确的 Tab (Property/Owner/Tenant)
			switchPropertyTab(type);
			
			window.app.handleNewEntry(type);
		}
	
		// ===================================
        // Quick Link Tenant Logic
        // ===================================
        let quickLinkPropId = null;
        let quickLinkSelectedTenant = null;
        let availableTenantsCache = [];

        function openQuickLinkModal(propId) {
            quickLinkPropId = propId;
            const prop = getPropertyById(propId);
            if (!prop) return;

            // 1. 筛选可用的租客 (已完成设置 且 当前未绑定其他房产)
            // 注意：tenants array 是全局变量
            // 获取所有已被分配的 tenantId
            const assignedTenantIds = properties.filter(p => p.tenantId && p.id !== propId).map(p => p.tenantId);
            
            availableTenantsCache = tenants.filter(t => 
                t.phase >= 4 && // 必须是 Setup Complete
                !assignedTenantIds.includes(t.id) // 未被其他房产占用
            );

            // 2. 重置 UI
            document.getElementById('quickLinkSearch').value = '';
            window.app.switchQuickLinkState('list');
            
            // 3. 渲染列表
            renderQuickLinkList(availableTenantsCache);

            // 4. 显示弹窗
            document.getElementById('quickLinkModal').style.display = 'flex';
        }

        function closeQuickLinkModal() {
            document.getElementById('quickLinkModal').style.display = 'none';
            quickLinkPropId = null;
            quickLinkSelectedTenant = null;
        }

        function renderQuickLinkList(list) {
            const container = document.getElementById('quickLinkListContainer');
            container.innerHTML = '';

            if (list.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px 20px;">
                        <div style="width: 70px; height: 70px; background: #f5f7fa; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                            <span class="material-icons-round" style="font-size: 36px; color: #ccc;">person_off</span>
                        </div>
                        
                        <h4 style="margin: 0 0 6px 0; color: #333; font-size: 16px;">No available tenants</h4>
                        <p style="color: #999; font-size: 13px; margin: 0 0 25px 0;">
                            Create a profile to link a tenant.
                        </p>
                        
                        <button class="empty-state-create-btn" onclick="window.app.navigateAndAdd('tenant'); window.app.closeQuickLinkModal();">
                            <span class="material-icons-round" style="font-size: 18px;">person_add</span>
                            Create New Tenant
                        </button>
                    </div>
                `;
                return;
            }

            list.forEach(t => {
                const initial = t.fullName ? t.fullName.charAt(0).toUpperCase() : 'T';
                const div = document.createElement('div');
                div.className = 'tenant-select-item';
                div.onclick = () => window.app.selectQuickLinkTenant(t.id);
                
                // ========== 修改了下面这一段 HTML ==========
                div.innerHTML = `
                    <div class="tenant-avatar-placeholder">${initial}</div>
                    <div class="tenant-select-info">
                        <h4>${t.fullName}</h4>
                        <p>IC: ${t.icPassport || 'No ID'}</p>
                    </div>
                    <span class="material-icons-round" style="color: #ccc; margin-left: auto;">chevron_right</span>
                `;
                // =========================================
                
                container.appendChild(div);
            });
        }

        function filterQuickLinkTenants(text) {
            const term = text.toLowerCase();
            const filtered = availableTenantsCache.filter(t => 
                (t.fullName && t.fullName.toLowerCase().includes(term)) ||
                // 新增：允许搜索 IC 号码
                (t.icPassport && t.icPassport.toLowerCase().includes(term)) 
            );
            renderQuickLinkList(filtered);
        }

        function switchQuickLinkState(state) {
            if (state === 'list') {
                document.getElementById('quickLinkListState').style.display = 'flex';
                document.getElementById('quickLinkConfirmState').style.display = 'none';
            } else {
                document.getElementById('quickLinkListState').style.display = 'none';
                document.getElementById('quickLinkConfirmState').style.display = 'flex';
            }
        }

        function selectQuickLinkTenant(tenantId) {
            quickLinkSelectedTenant = getTenantById(tenantId);
            const prop = getPropertyById(quickLinkPropId); // 获取当前房产信息

            if (!quickLinkSelectedTenant || !prop) return;

            // 1. 更新确认页面的：租客名字
            document.getElementById('quickLinkTenantName').textContent = quickLinkSelectedTenant.fullName;
            
            // 2. 更新确认页面的：房产名字 (新增)
            document.getElementById('quickLinkPropName').textContent = prop.name; 
            
            // 3. 绑定确认按钮事件
            document.getElementById('btnConfirmQuickLink').onclick = confirmLinkTenant;

            // 4. 切换视图
            switchQuickLinkState('confirm');
        }

        function confirmLinkTenant() {
            if (!quickLinkPropId || !quickLinkSelectedTenant) return;

            const prop = getPropertyById(quickLinkPropId);
            
            // 1. 更新房产数据
            updatePropertyData(quickLinkPropId, {
                ...prop,
                tenantId: quickLinkSelectedTenant.id,
                status: 'Rented'
            });

            // 2. 创建收租提醒任务 (复用现有逻辑)
            if (window.app.createFirstRentTask) {
                window.app.createFirstRentTask(quickLinkPropId, prop.name);
            } else {
                createFirstRentTask(quickLinkPropId, prop.name);
            }

            // 3. 提示成功并关闭
            alertMessage(`${quickLinkSelectedTenant.fullName} linked to ${prop.name} successfully!`, 'success');
            closeQuickLinkModal();

            // 4. 刷新列表 (关键步骤，让按钮消失，显示租客名字)
            renderProperties();
        }

		// 1. 打开弹窗的函数
        function openQuickOwnerModal(prefillName = '') {
            // 重置表单
            document.getElementById('quickOwnerForm').reset();
            
            // 如果是从搜索框点进来的，自动填入名字
            if (prefillName) {
                document.getElementById('qo-name').value = prefillName;
            }
            
            // 显示弹窗
            document.getElementById('quickOwnerModal').style.display = 'flex';
        }

        // 2. 处理弹窗提交 (保存数据 -> 关弹窗 -> 跳下一步)
        function handleQuickOwnerSubmit(e) {
            e.preventDefault();
            
            // 获取表单数据
            const name = document.getElementById('qo-name').value;
            const phone = document.getElementById('qo-phone').value;
            const email = document.getElementById('qo-email').value;
            const bankDetails = document.getElementById('qo-bank').value;
            const managementFee = document.getElementById('qo-fee').value;
            const address = document.getElementById('qo-address').value;
            
            // 创建新 ID
            const newId = `owner-${Date.now()}`;
            
            // 保存完整的 Owner 数据
            saveOwnerData(newId, {
                id: newId,
                fullName: name,
                phone: phone,
                email: email,
                bankDetails: bankDetails,
                managementFee: managementFee,
                address: address
            });
            
            // 成功提示
            window.app.alertMessage('Owner profile created successfully!', 'success');

            // 关闭弹窗
            document.getElementById('quickOwnerModal').style.display = 'none';
            
            // 【核心体验】自动选中并跳转到 Property Details
            selectOwnerAndProceed(newId);
        }

        // 3. 选中并跳转下一步 (这是让流程顺滑的关键)
        function selectOwnerAndProceed(ownerId) {
            const currentPropId = document.getElementById('currentId').value;
            
            // 更新房产数据，关联 Owner，并标记进度为 Phase 1
            updatePropertyData(currentPropId, { 
                phase: 1, 
                ownerId: ownerId 
            });

            // 更新任务状态
            updateTaskData(`task-${currentPropId}`, { 
                id: `task-${currentPropId}`, 
                type: 'property', 
                propId: currentPropId, 
                phase: 1, 
                description: 'Setup New Property', 
                details: 'Step 2/2: Basic Property Details.', 
                status: 'in_progress', 
                userId: currentUserId 
            });

            // 立即渲染下一页
            renderForm(currentPropId, 1, 'property');
        }



        // ===================================
        // Global App Exposure & Initialization
        // ===================================

        window.app = {
            startApp: function() {
                showLoading();
                loadData();
                renderProperties(); 
                renderTasks();
                switchView('dashboard'); 
                
                // Bind search bar for real-time filtering (Point 5)
                document.getElementById('propertySearch').addEventListener('input', window.app.filterProperties);
                
                hideLoading(); 
            },
            simpleTenantEdit: false,
            switchView: switchView,
			navigateAndAdd: navigateAndAdd,
            toggleAddMenu: toggleAddMenu,
            handleNewEntry: handleNewEntry,
            continueFormTask: continueFormTask,
            alertMessage: alertMessage,
            goBackFromForm: goBackFromForm,
            deletePropertyHandler: deletePropertyHandler,
            deleteProfileHandler: deleteProfileHandler,
			openQuickLinkModal: openQuickLinkModal,
			closeQuickLinkModal: closeQuickLinkModal,
			filterQuickLinkTenants: filterQuickLinkTenants,
			selectQuickLinkTenant: selectQuickLinkTenant,
			switchQuickLinkState: switchQuickLinkState,
            viewPropertyDetails: viewPropertyDetails,
			openQuickOwnerModal: openQuickOwnerModal,
			handleQuickOwnerSubmit: handleQuickOwnerSubmit,
			selectOwnerAndProceed: selectOwnerAndProceed,
            viewOwnerDetails: viewOwnerDetails,
            viewTenantDetails: viewTenantDetails,
            renderForm: renderForm, 
            sendRentReminder: sendRentReminder, // (Point 3)
			createFirstRentTask: createFirstRentTask,
            selectOwner: function(ownerId) { 
                document.getElementById('selectedOwnerId').value = ownerId;
                document.getElementById('formSubmitButton').disabled = false;
                document.getElementById('formSubmitButton').textContent = 'Next';
                document.querySelectorAll('.owner-select-item').forEach(item => {
                    const icon = item.querySelector('.material-icons-round');
                    if (item.getAttribute('data-owner-id') === ownerId) {
                        item.classList.add('selected');
                        icon.textContent = 'radio_button_checked';
                    } else {
                        item.classList.remove('selected');
                        icon.textContent = 'radio_button_unchecked';
                    }
                });
            },
			validateNumber: function(input) {
				// 1. 检查是否有非数字字符 (排除 0-9 以外的所有字符)
				// 注意：type="number" 的输入框在某些浏览器会自动过滤，但为了保险我们手动处理
				if (/[^0-9]/.test(input.value)) {
					
					// 2. 只有当确实检测到非法字符时，才执行替换和弹窗
					// 这样不会干扰正常的数字输入
					input.value = input.value.replace(/[^0-9]/g, '');
					
					// 3. 弹出错误提示 (调用你现有的 message box)
					window.app.alertMessage('Numbers only', 'error');
				}
			},
			calculateEndDate: function() {
				const startInput = document.getElementById('t-leaseStart');
				const termInput = document.getElementById('t-leaseTerm');
				const endInput = document.getElementById('t-leaseEnd');

				// 如果开始日期或租期没填，就不计算
				if (!startInput.value || !termInput.value) return;

				// 获取数值
				const startDate = new Date(startInput.value);
				const months = parseInt(termInput.value);

				// 计算逻辑：开始日期 + X个月 - 1天
				// 例如：1 Jan 2024 + 12个月 = 1 Jan 2025，再减1天 = 31 Dec 2024
				const endDate = new Date(startDate);
				endDate.setMonth(endDate.getMonth() + months);
				endDate.setDate(endDate.getDate() - 1);

				// 格式化为 YYYY-MM-DD 以便填入 input type="date"
				const yyyy = endDate.getFullYear();
				const mm = String(endDate.getMonth() + 1).padStart(2, '0');
				const dd = String(endDate.getDate()).padStart(2, '0');
				
				endInput.value = `${yyyy}-${mm}-${dd}`;
			},
			completeOnboardingTask: function(taskType) {
				// 1. 在 localStorage 记录这个任务已经被用户手动“杀掉”了
				// key 例如: 'setup_property_done', 'setup_owner_done'
				localStorage.setItem(`setup_${taskType}_done`, 'true');
				
				// 2. 给用户一点反馈 (可选：弹个窗表扬一下)
				window.app.alertMessage(`Great job! ${taskType} setup task completed.`, 'success');
				
				// 3. 刷新任务列表，让这个任务消失
				renderTasks();
			},
			
            handleFormSubmit: handleFormSubmit, 
            updateRentLabel: updateRentLabel, 
            toggleCollapse: toggleCollapse, 
            viewDummyFile: viewDummyFile, 
            selectTenant: selectTenant, 
            checkSelectPlaceholder: checkSelectPlaceholder,
            switchPropertyTab: switchPropertyTab,
			selectOwnerAndProceed: selectOwnerAndProceed, // 新增注册
            filterProperties: filterProperties, 
            filterOwners: (filter) => { 
                const ownerListContainer = document.getElementById('ownerListContainer');
                if (!ownerListContainer) return; // 防止在空状态页调用报错

                const filterValue = (filter || '').toLowerCase().trim();
                
                // 筛选逻辑
                const filteredOwners = owners.filter(o => 
                    (o.fullName && o.fullName.toLowerCase().includes(filterValue)) ||
                    (o.phone && o.phone.includes(filterValue))
                );

                // 如果没搜到
                if (filteredOwners.length === 0) {
                    ownerListContainer.innerHTML = `
                        <div style="text-align: center; padding: 30px 10px;">
                            <span class="material-icons-round" style="color: #ddd; font-size: 48px;">search_off</span>
                            <p style="color: #999; margin-top: 10px;">No owner found named "${filterValue}"</p>
                        </div>
                    `;
                    return;
                }

                // 渲染卡片列表
                ownerListContainer.innerHTML = filteredOwners.map(o => {
                    const initial = o.fullName ? o.fullName.charAt(0).toUpperCase() : 'O';
                    
                    // 注意：这里的 onclick 改成了 selectOwnerAndProceed
                    return `
                        <div class="owner-select-card" onclick="window.app.selectOwnerAndProceed('${o.id}')">
                            <div class="owner-icon-placeholder">${initial}</div>
                            <div class="owner-card-info">
                                <h4>${o.fullName || 'Unknown'}</h4>
                                <p><span class="material-icons-round" style="font-size: 12px; vertical-align: -1px;">phone</span> ${o.phone || 'No Phone'}</p>
                            </div>
                            <span class="material-icons-round" style="margin-left: auto; color: #ccc;">chevron_right</span>
                        </div>
                    `;
                }).join('');
            }
        };

        // Start the application on window load
        window.onload = window.app.startApp;
    </script>
</body>
</html>
